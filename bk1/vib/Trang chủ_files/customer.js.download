var templatefile = "/DesktopModules/VIBEBank/jstemplate.html?v=1";
var templatefileaddtemptobody = false;
var templateTransIBA = "/DesktopModules/VIB.Modules.PayAnyOne/ucTransactionManagement/templateTransIBA.html?v=1";
//var vibglobal_keyencryptcard = "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzQ5ztQczcVoq3gmB4A6iQJvW6qmLl7pnRIudHfSdIe9q2s5QLt+3evqDvj57NbsutpBg3t2TJkoVrxa3riXq0Y8/VqPT0JEBoPynuoTffZ65t7Zvveq3xwxyKEeUAEHwVGwV7OZ4fJGYKGM+a6BKsEqaF2PqvUTqYmWykFhhE73zHRRHtYFgTOCXCkUaLWJ1P6SEf0CGoZHgyHuiTWd2IXyfIRfr9ueJ0YiFGdz2oSsJeQLL7ffaLGYit5hd6nbHoyReSchzWj+W1Pc0Hgdpqcfjee1yDxn18RMMZwTAbcp3Ns+b0NkyVJag59+g/G/4+JHDmhqUzz558qoJuOv1aQIDAQAB";
var vibglobal_keyencryptcard = "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0Lf8tQ8fvKhIb5HBlLKNhhSZ5UHCkKhOJk39jbchJjvXdaNiBcBaqfXHwtgym1CndZlXKPwlxFWP3wvaehIFtBStvv/64Lhm4C12kf1QN/nwZ1S7iLuCoNQ+xQ1Q1aC8P/Pc8m/6MJ0Kej1Id+sVNsJxQHspBDO5v6sdPj07eH+Jd3SAklYOPH1JZzqPTbkiuiuVRFiXOvt4YF4ZWOz14FFE/F3S1UNONSsB32tBQJXRHNRTMBtPXH6XMp4HXVyLqLnCYyVo0VimFun+YDkNq3/Z/0RmXcGWw6gSag2TxB7JUNWGWly6OT3UFYYtRRfO4HCB24pBd+LuKKq3ZJLf+QIDAQAB";
var rbExchangeRate = {
    sf: null,
    bs: null,
    Init: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('IBRBController') + 'Customer/';
    },
    Load: function () {
        $.ajax({
            type: "GET",
            url: this.bs + "GetExchangeRate",
            beforeSend: this.sf.setModuleHeaders,
            contentType: "application/json; charset=utf-8",
            success: function (result) {
                if (typeof result !== "undefined" && result != null) {
                    if (result.STATUSCODE === '000000') {
                        for (var i = 0; i < result.data.length; i++) {
                            $('#sperv' + result.data[i].Name).html(result.data[i].Name + '&nbsp;&nbsp;' + result.data[i].Rate);
                        }
                    }
                }
            },
            error: function () {
            }
        });
    }
}

var rbUserHeader = {
    sf: null,
    bs: null,
    Init: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('IBRBController') + 'Customer/';
    },
    InitAvatar: function () {
        //LoadNotice();
        $("#file_edit_avatar").change(function () {
            rbUserHeader.readURL(this);
        });
        $(".fl-box-edit-avatar-list .fl-box-edit-avatar-item").click(function () {
            $(".fl-box-avatar-drag-drop-img").html($(this).html());
        });
        $("#fl-account-header-avatar").click(function () {
            var obj_edit = $(".fl-box-edit-avatar");
            if (obj_edit) {
                $(obj_edit).toggleClass("hidden");
            }
        });
        $("#aSaveAvatar").click(function () {
            rbUserHeader.SaveAvatar();
        });
    },
    readURL: function (input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                $(".fl-box-avatar-drag-drop-img").html('<img src="' + e.target.result + '" />');
            }
            reader.readAsDataURL(input.files[0]);
        }
    },
    SaveAvatar: function () {
        //var datap = new FormData();
        //datap.append("imgurl", $(".fl-box-avatar-drag-drop-img img").attr("src"));
        var datap = {
            imgurl: $(".fl-box-avatar-drag-drop-img img").attr("src")
        };
        $.ajax({
            type: "POST",
            url: this.bs + "UploadAvatar",
            data: JSON.stringify(datap),
            cache: false,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            beforeSend: this.sf.setModuleHeaders,
        }).done(function (data) {
            if (data.STATUSCODE !== "000000") {
                alert(data.MESSAGE);
            } else {
                $("#fl-account-header-avatar img").attr("src", $(".fl-box-avatar-drag-drop-img img").attr("src"));
                $(".fl-box-edit-avatar").toggleClass("hidden");
            }
        });
    },
    LoadNotice: function () {

    }
}

var rbacctportf = {
    sf: null,
    bs: null,
    vibconstance: null,
    addtemptobody: false,
    Init: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('IBRBController') + 'Customer/';
        //this.vibconstance = constance;
    },
    ShowMyHome: function () {
        $.ajax({
            type: "GET",
            url: this.bs + "MyAcctListHome",
            beforeSend: this.sf.setModuleHeaders,
            cache: false,
            success: function (rs) {
                if (typeof rs !== "undefined" && rs != null) {
                    if (rs.STATUSCODE === "000000") {
                        $.get(templatefile, null, function (templates) {
                            if (!templatefileaddtemptobody) {
                                $('body').append(templates);
                                templatefileaddtemptobody = true;
                            }
                            $("#temprbhomeacctport").tmpl(rs.data).appendTo($("#myacctlist"));
                            $("#divSumAcctInfo div[vib-type='ccy']").html(rs.BaseCCY);
                            $("#divSumAcctInfo div[vib-type='totalcredit']").html(rs.strTotalCredit);
                            $("#divSumAcctInfo div[vib-type='totaldebit']").html(rs.strTotalDebit);
                            $("#divSumAcctInfo div[vib-type='netbal']").html(rs.strNetBal);
                        });
                    }
                }
            }
        });
    }
}

var rbaccttranhist = {
    sf: null,
    bs: null,
    addtemptobody: false,
    Init: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('IBRBController') + 'Customer/';
    },
    ShowMyHome: function () {
        for (var i = 5; i >= 0; i--) {
            var imonth = vibconstancetranhisthome.CurrentMonth - i;
            var iyear = vibconstancetranhisthome.CurrentYear;
            if (imonth <= 0) {
                imonth = 12 + imonth;
                iyear--;
            }
            var li = $('<li/>', {
                class: 'fl-home-month-slide-item',
                html: vibconstancetranhisthome.arrMonth[imonth - 1] + " " + iyear
            });
            li.attr("vib-data", imonth + "-" + iyear);
            //if (i === 0) {
            //    li.addClass("active");
            //}
            li.appendTo("#transaction-month-slide");
        }
        //var slide_month_max = 5;

        var slide_month_item_w = $(".fl-home-month-slide-item").outerWidth();
        var w = slide_month_item_w * 6 + 30;
        //var slide_month_item_hidden = slide_month_max - 3;
        //var slide_month_item_to = slide_month_max;
        //var slide_month_item_from = slide_month_item_hidden;
        var slide_month_left = -(1 * slide_month_item_w) - 30;

        $("#transaction-month-slide").css("width", w + 'px');
        $("#transaction-month-slide").css("left", slide_month_left + 'px');

        $("#transaction-month-slide li").click(function () {
            $("#transaction-month-slide li").removeClass("active");
            $(this).addClass("active");
            rbaccttranhist.GetTransList(true, "month", $(this).attr("vib-data"));
        });
        $(".fl-owl-next").click(function () {
            var _left = parseInt($("#transaction-month-slide").css("left").replace("px", ""));
            var _width = parseInt($("#transaction-month-slide").css("width").replace("px", ""));
            var _parentwidth = parseInt($(".fl-home-transaction-month-slide").css("width").replace("px", ""));
            var _itemwidth = parseInt($(".fl-home-month-slide-item").outerWidth());
            //console.log(_width + _left - _itemwidth);
            if (_parentwidth - 30 >= _width + _left - _itemwidth) {
                return false;
            }
            $("#transaction-month-slide").animate({ left: _left - _itemwidth }, 500);
            //var slide_month_current = parseInt($("#transaction-month-slide li.active").index());

            //if (slide_month_current < 6 && slide_month_item_to < 6) {
            //    slide_month_left -= slide_month_item_w;
            //    slide_month_item_to += 1;
            //    slide_month_item_from += 1;
            //    $("#transaction-month-slide").animate({ left: slide_month_left }, 500);
            //}
        });
        $(".fl-owl-prev").click(function () {
            var _left = parseInt($("#transaction-month-slide").css("left").replace("px", ""));
            //var _width = parseInt($("#transaction-month-slide").css("width").replace("px", ""));
            //var _parentwidth = parseInt($(".fl-home-transaction-month-slide").css("width").replace("px", ""));
            var _itemwidth = parseInt($(".fl-home-month-slide-item").outerWidth());
            if (40 <= _left + _itemwidth) {
                return false;
            }
            $("#transaction-month-slide").animate({ left: _left + _itemwidth }, 500);
            //var slide_month_current = parseInt($("#transaction-month-slide li.active").index());
            //if (slide_month_current >= 0 && slide_month_item_from > 0) {
            //    slide_month_left += slide_month_item_w;
            //    slide_month_item_to -= 1;
            //    slide_month_item_from -= 1;
            //    $("#transaction-month-slide").animate({ left: slide_month_left }, 500);
            //}
        });

        $(".fl-home-all-history-tranaction-content").scroll(function () {
            if ($("#translist li").last().offset().top <= $(".fl-home-all-history-tranaction-footer").offset().top - 35) {
                rbaccttranhist.LoadMoreTranHist();
            }
        });
        jQuery_1_11_1('#ddltranhistacct').on('change', function () {
            $("#transaction-month-slide li").last().addClass("active").click();
            jQuery_1_11_1('#ddltranhistacct').prettyDropdown().refresh();
        });
        $.ajax({
            type: "GET",
            url: this.bs + "TranHistAcctHome",
            beforeSend: this.sf.setModuleHeaders,
        }).done(function (rs) {
            if (rs.STATUSCODE === "000000" && rs.data != null) {
                $.each(rs.data, function (i, item) {
                    $("#ddltranhistacct optgroup").append($('<option>', {
                        value: item.AcctIdSec,
                        text: item.ProductTitle + " - " + item.AcctId
                    }).attr("img-icon", item.ProductIcon).attr("vib-type", item.ProductType));
                });
                jQuery_1_11_1('#ddltranhistacct').prettyDropdown();
                $("#transaction-month-slide li").last().addClass("active").click();
            }
        });
    },
    GetTransList: function (isrefresh, timetype, dtfrom, pageindex) {
        if (dnn.getVar("GetTransListRunning") === "Y" || dnn.getVar("GetTransListDone") === "Y") {
            return;
        }
        dnn.setVar("GetTransListRunning", "Y");
        if (!timetype) {
            timetype = "";
        }
        if (!pageindex) {
            pageindex = "0";
        }
        dnn.setVar("CurrentSearch_timetype", timetype + "");
        dnn.setVar("CurrentSearch_dtfrom", dtfrom + "");
        dnn.setVar("CurrentSearch_pageindex", pageindex + "");
        if (isrefresh) {
            $("#translist").html("");
        }
        var dp = {
            timetype: timetype,
            dtfrom: dtfrom,
            acctid: $('#ddltranhistacct').val(),
            pi: pageindex,
            type: $('#ddltranhistacct').find(":selected").attr("vib-type"),
            language: $("html").attr("lang")
        }
        $.ajax({
            type: "GET",
            url: this.bs + "GetTransList",
            data: dp,
            cache: false,
            beforeSend: this.sf.setModuleHeaders,
        }).done(function (data) {
            if (data.STATUSCODE === "000000") {
                $.get(templatefile, null, function (templates) {
                    var pi = dnn.getVar("CurrentSearch_pageindex");
                    if (pi === "0") {
                        dnn.setVar("CurrentSearch_TotalItem", data.TotalRecord + "");
                        if (data.TotalRecord == 0) {
                            rbaccttranhist.ShowEmptyTranHist();
                        } else {
                            $("#divtranhistfooter").show();
                            $("#divTransactionNoItemContent").hide();
                        }
                    }

                    if (!templatefileaddtemptobody) {
                        $('body').append(templates);
                        templatefileaddtemptobody = true;
                    }
                    $("#temprbhometranslist").tmpl(data.data).appendTo($("#translist"));
                    dnn.setVar("GetTransListRunning", "N");
                });
            }
        });
    },
    ShowEmptyTranHist: function () {
        $("#translist").html("");
        $("#divtranhistfooter").hide();
        $("#divTransactionNoItemContent").show();
    },
    LoadMoreTranHist: function () {
        var totaltran = parseInt(dnn.getVar("CurrentSearch_TotalItem"));
        if (totaltran <= $("#translist li").length) {
            return;
        }
        var timetype = dnn.getVar("CurrentSearch_timetype");
        var dtfrom = dnn.getVar("CurrentSearch_dtfrom");
        var pageindex = parseInt(dnn.getVar("CurrentSearch_pageindex"));
        rbaccttranhist.GetTransList(false, timetype, dtfrom, pageindex + 1);
    },
}

var rbmycard = {
    templatefile: "/DesktopModules/VIBEBank/jstemplate.html?v=1",
    addtemptobody: false,
    sf: null,
    bs: null,
    bsai: null,
    Init: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('IBRBController') + 'Customer/';
        this.bsai = this.sf.getServiceRoot('RBAccountInformation') + 'WebAPI/';
       /* $("#ashowcardpointdetail").click(function () {
            if ($("#divContent").hasClass("card-disabled")) return;
            if ($(this).hasClass("expand")) {
                $(this).removeClass("expand");
                $(this).html("+");
                $("#divCardPointDetail").hide();
            } else {
                $(this).addClass("expand");
                $(this).html("-");
                $("#divCardPointDetail").show();
                rbmycard.GetPoint();
            }
        });*/
        rbmycard.InitOTPBox();
        $("#fl-icon-export").click(function () {
            $("#fl-tranaction-export").toggleClass('hidden');
        });
        $("#fl-close-tranaction-export").click(function () {
            $("#fl-tranaction-export").toggleClass('hidden');
        });
        $(".fl-tranaction-export-popup").click(function () {
            $("#fl-tranaction-export").toggleClass('hidden');
        });
        $("#fl-tranaction-export [vib-type='exporttranhist']").click(function () {
            rbmycard.ExportTranHist($(this).attr("vib-data"));
        });
        $(".fl-home-all-history-tranaction-content").scroll(function () {
            if ($("#translist li").last().offset().top <= $(".fl-home-all-history-tranaction-footer").offset().top - 35) {
                rbmycard.LoadMoreTranHist();
            }
        });
        $("#aactive").click(function () {
            if ($(this).hasClass("disabled")) return;
            rbmycard.ResetOTP();
            dnn.setVar("CurrentPopupAction", "ACTIVE");
            rbmycard.aactive_click();
        });
        //$("#alock").click(function () {
        //    if ($(this).hasClass("disabled")) return;
        //    dnn.setVar("CurrentPopupAction", $(this).attr("vib-action"));
        //    rbmycard.ResetOTP();
        //    rbmycard.alock_click();
        //});
        //$("#acommerce").click(function () {
        //    if ($(this).hasClass("disabled")) return;
        //    dnn.setVar("CurrentPopupAction", $(this).attr("vib-action"));
        //    rbmycard.ResetOTP();
        //    rbmycard.acommerce_click();
        //});
        $(".btn-alock").click(function () {
            if ($(this).hasClass("disabled")) return;
            dnn.setVar("CurrentPopupAction", $(this).attr("vib-action"));
            rbmycard.ResetOTP();
            rbmycard.alock_click();
        });
        $("#aLock3").click(function () {
            $(".btn-alock").click();
        });        
        $(".btn-acommerce").click(function () {
            if ($(this).hasClass("disabled")) return;
            dnn.setVar("CurrentPopupAction", $(this).attr("vib-action"));
            rbmycard.ResetOTP();
            rbmycard.acommerce_click();
        });
        $("#aClosePopup").click(function () {
            dnn.setVar('WidgetCardLoad' + dnn.getVar('CurrentCardView'), "N")
            $("div.fl-mycard-supplementary-item[vib-data='" + dnn.getVar('CurrentCardView') + "']").click();
            $.fancybox.close();
        });
        $("#aPopupCardModNext").click(function () {
            $.fancybox.close();
            $.fancybox({
                href: "#divPopupOTP",
                helpers: {
                    overlay: { closeClick: false } //Disable click outside event
                }
            });
        });
        $("#aPopupCardConfirm").click(function () {
            rbmycard.CardModSubmit();
        });
        $("#aprinttranhist").click(function () {
            rbmycard.PrintTranHist();
        });
        $("#divfiltersearch .fl-icon-cancel").click(function () {
            $("#divtransaction-month-slide").show();
            $("#divfiltersearch").hide();
            $("#transaction-month-slide li").last().addClass("active").click();
        });
        $(".fl-history-tranaction-search-advanced").click(function () {
            $.fancybox({ href: "#divadvsearch", 'closeBtn': false, padding: 0, background: 'transparent', minWidth:693 });
            $(".fl-history-tranaction-search-advanced-box .closeBtn").click(function () {
                $.fancybox.close();
            });
        });
        $("#aadvsearch").click(function () {
            rbmycard.AdvanceSearch_Click();
        });
        $(".fl-search-item-tab li").click(function () {
            $(this).parent().find('li').removeClass('active');
            $(this).addClass('active');
        });
        $("#ultimetype li").click(function () {
            $(".fl-search-row-time-box").addClass('hidden');
            $("." + $(this).attr('data-show')).removeClass('hidden');
            $(".fl-datepicker img").click(function () {
                $(this).parent().find(".datepicker").datepicker('show');
            });
        });

        $(".fl-mycard-supplementary-item").click(function () {
            var cardser = $(this).attr("vib-data");
            dnn.setVar('CurrentCardView', cardser);
            $(".fl-mycard-supplementary-item").show();
            $(this).hide();
            rbmycard.GetCardInfo(cardser);
        });
        if ($(".fl-mycard-supplementary-item").length > 0) {
            if (dnn.getVar("SELECTEDCARD")) {
                $("#divListCard [vib-data='" + dnn.getVar("SELECTEDCARD") + "']").click();
            } else {
                $(".fl-mycard-supplementary-item")[0].click();
            }
        }
        if ($(".fl-mycard-supplementary-item").length <= 1) {
            $("#divListCard").hide();
        }
        $("#aViewSecretInfo").click(function () {            
            if ($(this).hasClass("disabled")) return;
            dnn.setVar("CurrentPopupAction", 'VIEWSECRET');
            rbmycard.ResetOTP();
            $.fancybox.close();
            $.fancybox({
                href: "#divPopupOTP",
                helpers: {
                    overlay: { closeClick: false } //Disable click outside event
                }
            });
        });
        $( "#aViewSecretInfo" ).hover(
          function() {
            if ($(this).hasClass("disabled")) return;
            $("#divViewSecretHint").show();
          }, function() {
            $("#divViewSecretHint").hide();
          }
        );

        $(".btn-aatm").click(function () {
            if ($(this).hasClass("disabled")) return;
            dnn.setVar("CurrentPopupAction", $(this).attr("vib-action"));
            rbmycard.ResetOTP();
            rbmycard.asale_click();
        });
        //
        //console.log($.url('?cardser', window.location.href));
        rbmycard.InitDateSearch();
        rbmycard.ShowHideCardDetailControl();
    },
    InitWidget: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('IBRBController') + 'Customer/';
        this.bsai = this.sf.getServiceRoot('RBAccountInformation') + 'WebAPI/';
        rbmycard.InitOTPBox();
        $("#aPopupCardModNext").click(function () {
            $.fancybox.close();
            $.fancybox({
                href: "#divPopupOTP",
                helpers: {
                    overlay: { closeClick: false } //Disable click outside event
                }
            });
        });
        $("#aPopupCardConfirm").click(function () {
            rbmycard.CardModSubmit();
        });
        $("#aClosePopup").click(function () {
            dnn.setVar('WidgetCardLoad' + dnn.getVar('CurrentCardView'), "N");
            rbmycard.Widget_GetInfo(dnn.getVar('CurrentCardView'));
            $.fancybox.close();
        });
        $.ajax({
            type: "GET",
            url: this.bs + "MyCardList",
            cache: false,
            beforeSend: this.sf.setModuleHeaders,
        }).done(function (rs) {
            if (rs.STATUSCODE === "000000" && rs.data != null && rs.data.length > 0) {
                $.get(templatefile, null, function (templates) {
                    if (!templatefileaddtemptobody) {
                        $('body').append(templates);
                        templatefileaddtemptobody = true;
                    }
                    $("#temprbmycardwidget").tmpl(rs.data).appendTo($("#divcardwidgetitem"));
                    jQuery_1_11_1("#divcardwidgetitem").owlCarousel({
                        autoPlay: false,
                        items: 1,
                        mouseDrag: true,
                        pagination: true,
                        navigation: true,
                        animateOut: 'fadeOut',
                        responsive: false,
                        afterMove: function (event) {
                            var current = this.currentItem;
                            //dnn.setVar("MyCardWidgetCurrentIndex", current);
                            rbmycard.Widget_GetInfo($($("#divcardwidgetitem .fl-mycar-right-item").get(current)).attr("vib-value"));
                        },
                        afterInit: function (event) {
                            //dnn.setVar("MyCardWidgetCurrentIndex", "0");
                            rbmycard.Widget_GetInfo($($("#divcardwidgetitem .fl-mycar-right-item").get(0)).attr("vib-value"));
                        }

                    });

                });
            } else {
                $("#divcardwidgetitem").html($("#divmycardwidgetnocard").html());
                $("#amycardwidgetdetail").hide();
            }
        });
    },
    InitOTPBox: function () {
        $("#aGetOtp").click(function () {
            rbmycard.agetotp_click();
        });
        $(".otp-box").keyup(function (e) {
            var charCode = (e.which) ? e.which : e.keyCode;
            //if ((charCode >= 48 && charCode <= 57) || (charCode >= 96 && charCode <= 105)) {
                var currentIndex = $(this).attr("id").replace('txtotp', '');
                if (nextIndex == 6) return;
                var nextIndex = parseInt(currentIndex) + 1;
                $(this).parent().find("#txtotp" + nextIndex).focus();
                //$(this).val(String.fromCharCode(charCode));
            //} else {
            //    $(this).val('');
            //}
        });
    },
    ResetOTP: function () {
        $("#txtotp1,#txtotp2,#txtotp3,#txtotp4,#txtotp5,#txtotp6").val("");
        $('#aGetOtp').show();
    },
    ShowHideCardDetailControl: function () {
        switch (dnn.getVar("SELECTEDTAB")) {
            case "MC":
                $(".fl-mycard-btn-action").hide();
                $(".list_services-card").show();
                $("#divSelectedCardInfo div[vib-type='rowissuedate']").hide();
                break;
            case "MCPP":
                $(".fl-mycard-btn-action").show();
                $(".list_services-card").hide();
                $("#apayoff,#licreditlimitbal").hide();
                $("#divSelectedCardInfo [vib-type='rowissuedate']").hide();
                $("#divSelectedCardInfo [vib-type='rowmindueamt']").hide();
                $("#divSelectedCardInfo [vib-type='rowcommitamt']").hide();
                $("#divSelectedCardInfo [vib-type='rowmaxdueamt']").hide();
                $("#divSelectedCardInfo [vib-type='rowduedate']").hide();
                $("#divSelectedCardInfo [vib-type='rowcardacctno']").hide();
                $("#divSelectedCardInfo [vib-type='rowlimit']").hide();
                //$("#acommerce,#alock").width('45%');
                $(".btn-acommerce,.btn-alock").width('45%');
                $("#liremainbal").removeClass("border-left");
                $("#btn-card-statement").hide();
                $("#btn-card-installment").hide();                
                break;
            case "ATM":
                $(".fl-mycard-btn-action").show();
                $(".list_services-card").hide();
                $("#liremainbal").hide();
                $("#divSelectedCardInfo div[vib-type='rowlimit']").hide();
                $("#divSelectedCardInfo div[vib-type='rowmindueamt']").hide();
                $("#divSelectedCardInfo div[vib-type='rowcommitamt']").hide();
                $("#divSelectedCardInfo div[vib-type='rowmaxdueamt']").hide();
                $("#divSelectedCardInfo div[vib-type='rowduedate']").hide();
                $("#divSelectedCardInfo div[vib-type='rowexpdate']").hide();
                $("#apayoff").hide();
                //$("#acommerce,#alock").width('45%');
                $(".btn-acommerce,.btn-alock").width('45%');
                $("#btn-card-statement").hide();
                $("#btn-card-installment").hide();
                break;
            default:
                break;
        }
    },
    InitDateSearch: function () {
        InitDatePickerMaxDate("#txtadvsearchfromdate", vibconstance.dtToDay);
        InitDatePickerMaxDate("#txtadvsearchtodate", vibconstance.dtToDay);
        for (var i = 5; i >= 0; i--) {
            var imonth = vibconstance.CurrentMonth - i;
            var iyear = vibconstance.CurrentYear;
            if (imonth <= 0) {
                imonth = 12 + imonth;
                iyear--;
            }
            var li = $('<li/>', {
                class: 'fl-home-month-slide-item',
                html: vibconstance.arrMonth[imonth - 1] + " " + iyear
            });
            li.attr("vib-data", imonth + "-" + iyear);
            //if (i === 0) {
            //    li.addClass("active");
            //}
            li.appendTo("#transaction-month-slide");
        }
        $("#transaction-month-slide li").click(function () {
            $("#transaction-month-slide li").removeClass("active");
            $(this).addClass("active");
            rbmycard.GetTransList(true, "month", $(this).attr("vib-data"));
        });
    },
    GetCardInfo: function (cardser) {
        //dnn.setVar("RELOADCARDPOINT", "Y");
        rbmycard.GetPoint(cardser);
        $.ajax({
            type: "GET",
            url: this.bsai + "MyCardInfo",
            data: { id: cardser },
            cache: false,
            beforeSend: this.sf.setModuleHeaders,
        }).done(function (data) {
            if (data.StatusCode === "000000") {
                if (data.IsDigi) {
                    $(".fl-mycard-info").hide();
                    $(".fl-mycard-digi-note").show();
                    $("#divSelectedCard img[vib-type='cardimg']").css("width", "185px");
                } else {
                    $(".fl-mycard-info").show();
                    $(".fl-mycard-digi-note").hide();
                }
                //$("#acommerce,#alock,#apayoff").removeClass("disabled").removeAttr("vib-action");
                $("#aactive").removeClass("disabled");
                $(".btn-acommerce,.btn-alock,#apayoff").removeClass("disabled").removeAttr("vib-action");
                //dnn.setVar("RELOADCARDPOINT", "Y");   
                var cardserno=   dnn.getVar('CurrentCardView');          
                var divitem = $("div.fl-mycard-supplementary-item[vib-data='" + dnn.getVar('CurrentCardView') + "']");
                $("#divSelectedCard img[vib-type='cardimg']").attr("src", divitem.find("img[vib-type='cardimg']").attr("src"));
                $("#divSelectedCard div[vib-type='cardname']").html(data.CardName);
                $("#divSelectedCardInfo div[vib-type='avaibal']").html(data.strAvailBal);
                $("#divSelectedCardInfo div[vib-type='avaiccy']").html(data.CCY);
                $("#divSelectedCardInfo div[vib-type='remainbal']").html(data.strRemainBal);
                $("#divSelectedCardInfo div[vib-type='remainccy']").html(data.CCY);
                $("#divSelectedCardInfo span[vib-type='cardno']").html(data.CardNo);
                $("#divSelectedCardInfo span[vib-type='limit']").html(data.strCreditLimit + " " + data.CCY);
                $("#divSelectedCardInfo span[vib-type='mindueamt']").html(data.strMinimumPayment + " " + data.CCY);
                $("#divSelectedCardInfo span[vib-type='commitamt']").html(data.strCommitPayment + " " + data.CCY);
                if (data.SHOWCOMMITAMT === false) {
                    $("#divSelectedCardInfo div[vib-type='rowcommitamt']").hide();
                }
                else {
                    $("#divSelectedCardInfo div[vib-type='rowcommitamt']").show();
                }
                $("#divSelectedCardInfo span[vib-type='maxdueamt']").html(data.strMaximumPayment + " " + data.CCY);
                $("#divSelectedCardInfo span[vib-type='cardacctno']").html(data.AcctNo);
                $("#divSelectedCardInfo span[vib-type='duedate']").html(data.strDueDate);
                $("#divSelectedCard span[vib-type='ngayphathanh']").html(data.CreatedDate);
                $("#divSelectedCard div[vib-type='loaithe']").html(data.ProductTypeName);
                $("#divSelectedCard div[vib-type='cardno']").html(data.CardNoFormated);
                $("#divSelectedCardInfo span[vib-type='expdate']").html(data.ExpDate);
                $("#divSelectedCardInfo span[vib-type='issuedate']").html(data.strIssueDate);
                $("#spSelectedCardStatus").html(data.strStatus);
                dnn.setVar("TRANSHISTTYPE", data.TRANSHISTTYPE);
                dnn.setVar("TRANSHISTACCTID", data.TRANSHISTACCTID);
                dnn.setVar("CARDDELIVERED_"+cardserno, data.DELIVERED);
                dnn.setVar("ECOMMERCED_"+ cardserno, data.ECOMMERCED);
                dnn.setVar("SALEENABLED_"+ cardserno, data.SALEENABLED);
                dnn.setVar("STATUS_"+ cardserno, data.Status);
                dnn.setVar("ACTIVED_"+ cardserno, data.ACTIVED);
                dnn.setVar("OTPREGISTERED_"+ cardserno, data.OTPREGISTERED);
                if (divitem.attr("vib-primary") == "True") {
                    $("#spSelectedCardisMain").html(vibconstance.txtTheChinh);
                } else {
                    $("#spSelectedCardisMain").html(vibconstance.txtThePhu);
                }
                if (data.ENABLE_VIEWDETAIL === "Y") {
                    $("#aViewSecretInfo").show();
                } else {
                    $("#aViewSecretInfo").hide();
                }

                if (divitem.attr("data-vibmc") == "True" && data.ACTIVED === "Y" && data.Status === "NORM") {
                    $("#aViewSecretInfo").removeClass("disabled");
                } else {
                    $("#aViewSecretInfo").addClass("disabled");
                }
                //if (data.SHOW_ECOMMERCE) {
                //    $("#acommerce").show();
                //} else {
                //    $("#acommerce").hide();
                //}
                //if (data.SHOW_LOCK) {
                //    $("#alock").show();
                //} else {
                //    $("#alock").hide();
                //}
                if (data.SHOW_ECOMMERCE) {
                    $(".btn-acommerce").show();
                } else {
                    $(".btn-acommerce").hide();
                }
                if (data.SHOW_LOCK) {
                    $(".btn-alock").show();
                } else {
                    $(".btn-alock").hide();
                }
                if (data.SHOW_SALE) {
                    $(".btn-aatm").show();
                } else {
                    $(".btn-aatm").hide();
                }
                $("#divContent").removeClass("card-actived").removeClass("card-disabled");
                if (data.ACTIVED === "N" || (data.ACTIVED =="Y" && data.Status =="NEW")) {
                    $("#divContent").addClass("card-disabled");
                    //$("#acommerce,#alock").addClass("disabled");
                    $(".btn-acommerce,.btn-alock,.btn-aatm,.btn-statement,#apayoff").addClass("disabled");
                    $("#btn-card-statement").attr("href", "javascript:void(0);");
                    $("#apayoff").attr("href", "javascript:void(0);");
                    $("#divselectedcardsubstatus").hide();
                    if(data.ACTIVED =="Y" && data.Status =="NEW"){
                        $("#divSelectedCard div[data-vibkey='msgwarningactive']").html(vibconstance.msgErrorCannotActiveOnline).show();
                        $("#aactive").addClass("disabled");
                    }
                    else{
                        $("#divSelectedCard div[data-vibkey='msgwarningactive']").html('');
                        $("#aactive").removeClass("disabled");
                    }
                } else {
                    $("#divContent").addClass("card-actived");
                    $("#btn-card-statement").removeClass("disabled").attr("href", data.UrlCardStatement);
                    $("#divselectedcardsubstatus").show();
	                if (data.UrlCardStatement=="") {
	                    $("#btn-card-statement").addClass("disabled").attr("href", "javascript:void(0);");
	                } else {
	                    $("#btn-card-statement").removeClass("disabled").attr("href", data.UrlCardStatement);
	                }
                }
                if (!data.PAY) {
                    $("#apayoff").addClass("disabled").attr("href", "javascript:void(0);");
                } else {
                    $("#apayoff").removeClass("disabled").attr("href", data.PayURL);
                }
                if (data.UrlCardInstallment) {
                    $("#btn-card-installment").removeClass("disabled").attr("href", data.UrlCardInstallment);
                }
                else {
                    $("#btn-card-installment").addClass("disabled").attr("href", "javascript:void(0);");
                }
                //if (data.LOCKED === "Y") {
                //    $("#alock").html(vibconstance.aUnLock).attr("vib-action", "UNLOCK");
                //    $("#acommerce").addClass("disabled");
                //} else {
                //    $("#alock").html(vibconstance.aLock).attr("vib-action", "LOCK");
                //}
                //if (data.ECOMMERCED === "Y") {
                //    $("#acommerce").html(vibconstance.aDISEommerce).attr("vib-action", "DISECOM");
                //} else {
                //    $("#acommerce").html(vibconstance.aECommerce).attr("vib-action", "ENECOM");
                //}

                if (data.SALEENABLED === "Y") {
                    $(".btn-aatm span").html(vibconstance.aDisableSale);
                    $("a.btn-aatm").attr("vib-action", "DISSALE");
                    $("#divselectedcardsubstatus").hide();
                    $("a.btn-aatm").removeClass("disabled");
                } else {
                    $("#spSelectedCardSubStatus").html(vibconstance.sttOffSALE);
                    $("#divselectedcardsubstatus").show();
                    $(".btn-aatm span").html(vibconstance.aEnableSale);
                    if(data.DELIVERED =="N"){
                        $("a.btn-aatm").addClass("disabled");
                    }
                    else{
                    $("a.btn-aatm").attr("vib-action", "ENSALE");
                        $("a.btn-aatm").removeClass("disabled");
                    }
                    
                }
                if (data.LOCKED === "Y") {
                    $(".btn-alock span").html(vibconstance.aUnLock);
                    $(".btn-alock").attr("vib-action", "UNLOCK");
                    $(".btn-acommerce").addClass("disabled");
                    $(".btn-aatm").addClass("disabled");
                } else {
                    $(".btn-alock span").html(vibconstance.aLock);
                    $(".btn-alock").attr("vib-action", "LOCK");
                }
                if(data.DELIVERED != "Y"){
                    $(".btn-aatm").addClass("disabled");
                }
                if (data.ECOMMERCED === "Y") {
                    $(".btn-acommerce span").html(vibconstance.aDISEommerce);
                    $(".btn-acommerce").attr("vib-action", "DISECOM");
                    //$("#divselectedcardsubstatus").hide();
                } else {
                    $(".btn-acommerce span").html(vibconstance.aECommerce);
                    $(".btn-acommerce").attr("vib-action", "ENECOM");
                    $("#spSelectedCardSubStatus").html(vibconstance.sttOffECOM);
                    $("#divselectedcardsubstatus").show();
                }
                if (data.INVISIBLEREWARDPOINT) {
                    $("#divCardPoint").hide();
                } else {
                    $("#divCardPoint").show();
                }
                if (!data.Enable) {
                    //$("#acommerce,#alock,#aactive").addClass("disabled");
                    $(".btn-acommerce,.btn-alock,#aactive,.btn-aatm").addClass("disabled");
                }
                if(data.DELIVERED != "Y" && data.OTPREGISTERED != "Y" && dnn.getVar("SELECTEDTAB")==="MC"){
                    $(".btn-acommerce,.btn-alock,#aactive").addClass("disabled");
                }
                if(data.ACTIVED =="N" || (data.ACTIVED =="Y" && data.Status =="NEW")){
                    $(".btn-acommerce,.btn-alock,.btn-aatm,.btn-statement,#apayoff").addClass("disabled");
                    $("#divselectedcardsubstatus").hide();
                }
                //get transhist
                if (data.ACTIVED === "Y") {
                    $("#transaction-month-slide li").last().addClass("active").click();
                    $("#txtadvsearchfromamt,#txtadvsearchtoamt").attr("vib-ccy", data.CCY);
                    $("#divadvsearch [vib-type='searchccy']").html(data.CCY);
                    if (data.CCY === "VND") {
                        $("#txtadvsearchfromamt,#txtadvsearchtoamt").autoNumeric('init', { vMax: '999999999999', vMin: '0' });
                    } else {
                        $("#txtadvsearchfromamt,#txtadvsearchtoamt").autoNumeric('init', { vMax: '999999999999.99', vMin: '0.00' });
                    }
                } else {
                    rbmycard.ShowEmptyTranHist();
                }
                rbmycard.change_height_other_card_div();

            }
        });
    },
    GetPoint: function (cardser) {
        /*if (dnn.getVar("RELOADCARDPOINT") === "N") {
            return;
        }*/
        //var cardser = dnn.getVar('CurrentCardView');
        $.ajax({
            type: "GET",
            url: this.bsai + "CardPoint",
            beforeSend: this.sf.setModuleHeaders,
            data: { cardser: cardser },
            cache: false,
            success: function (data) {
                if (data.StatusCode === "000000") {
                    var showtype = $("div.fl-mycard-supplementary-item[vib-data='" + dnn.getVar('CurrentCardView') + "']").attr("vib-type");                    
                    $("#divCardPoint span[vib-type='totalpointtitle']").html(vibconstance["txtTotalPoint"+showtype]);
                    $("#divCardPoint span[vib-type='totalpointvalue']").html(data.PointBalance + ' ' + vibconstance["txtTotalPoint"+showtype+"DonVi"]);                    
                }
            }
        });
    },
    alock_click: function () {
        var divitem = $("div.fl-mycard-supplementary-item[vib-data='" + dnn.getVar('CurrentCardView') + "']");
        $("#divPopupCardMod img[vib-type='imgcard']").attr("src", divitem.find("img[vib-type='cardimg']").attr("src"));
        $("#divPopupCardMod div[vib-type='cardname']").html($("#divSelectedCard  div[vib-type='cardname']").html());
        $("#divPopupCardMod div[vib-type='cardno']").html($("#divSelectedCard  div[vib-type='cardno']").html());
        $("#divPopupCardMod div[vib-type='producttype']").html($("#divSelectedCard  div[vib-type='loaithe']").html());
        $("#divPopupCardMod div[vib-type='message']").html("").hide();
        $("#divPopupCardMod div[vib-type='messagetop']").html(vibconstance["msgConfirm" + dnn.getVar("CurrentPopupAction")]).show();
        $("#aPopupCardModNext").html(vibconstance["txtaPopupNext" + dnn.getVar("CurrentPopupAction")]);
        $.fancybox({
            href: "#divPopupCardMod",
            helpers: {
                overlay: { closeClick: false } //Disable click outside event
            }
        });
    },
    acommerce_click: function () {
         var esale =dnn.getVar("SALEENABLED_"+ dnn.getVar("CurrentCardView"));
        if(esale =="N" && dnn.getVar("CurrentPopupAction")=="DISECOM"){
            $("#divMessagePopup span[data-vibkey='popupmsg']").html(vibconstance.msgErrorOnlySALE);
            $.fancybox({
            href: "#divMessagePopup",
            helpers: {
                overlay: { closeClick: false } //Disable click outside event
            }
            });
        }
        else{
        $("#divPopupCardMod img[vib-type='imgcard']").attr("src", vibconstance.imgConfirmECOM);
        $("#divPopupCardMod div[vib-type='cardname']").html("");
        $("#divPopupCardMod div[vib-type='cardno']").html("");
        $("#divPopupCardMod div[vib-type='producttype']").html("");
        $("#divPopupCardMod div[vib-type='message']").html(vibconstance["msgConfirm" + dnn.getVar("CurrentPopupAction")]).show();
        $("#divPopupCardMod div[vib-type='messagetop']").html("").hide();
        $("#aPopupCardModNext").html(vibconstance["txtaPopupNext" + dnn.getVar("CurrentPopupAction")]);
        $.fancybox({
            href: "#divPopupCardMod",
            helpers: {
                overlay: { closeClick: false } //Disable click outside event
            }
        });
    }
    },
    aactive_click: function () {
        //if (!confirm(vibconstance.msgActivedWarning)) return;
        var cardserno=dnn.getVar('CurrentCardView');
        var cardeliverd =dnn.getVar('CARDDELIVERED_'+ cardserno);
        var otp = dnn.getVar('OTPREGISTERED_'+ cardserno);
        /*var status =dnn.getVar("STATUS_"+ dnn.getVar("CurrentCardView"));
            var actived =dnn.getVar("ACTIVED_"+ dnn.getVar("CurrentCardView"));*/
        var divitem = $("div.fl-mycard-supplementary-item[vib-data='" + dnn.getVar('CurrentCardView') + "']");
        $("#divPopupCardMod img[vib-type='imgcard']").attr("src", divitem.find("img[vib-type='cardimg']").attr("src"));
        $("#divPopupCardMod div[vib-type='cardname']").html($("#divSelectedCard  div[vib-type='cardname']").html());
        $("#divPopupCardMod div[vib-type='cardno']").html($("#divSelectedCard  div[vib-type='cardno']").html());
        $("#divPopupCardMod div[vib-type='producttype']").html($("#divSelectedCard  div[vib-type='loaithe']").html());
        if(dnn.getVar("SELECTEDTAB")==="MC"){
            if(cardeliverd=="N" && otp=="Y"){
                $("#divPopupCardMod div[vib-type='message']").html(vibconstance.msgConfirmACTIVEMCNotDelevered).show();
            }
            else{
                $("#divPopupCardMod div[vib-type='message']").html(vibconstance.msgConfirmACTIVEMC).show();
            }
        }else{        
            $("#divPopupCardMod div[vib-type='message']").html(vibconstance.msgConfirmACTIVE).show();
        }
        $("#divPopupCardMod div[vib-type='messagetop']").html("").hide();
        $("#aPopupCardModNext").html(vibconstance["txtaPopupNext" + dnn.getVar("CurrentPopupAction")]);
        $.fancybox({
            href: "#divPopupCardMod",
            helpers: {
                overlay: { closeClick: false } //Disable click outside event
            }
        });
    },
    agetotp_click: function () {
        $.ajax({
            type: "GET",
            cache: false,
            url: "/API/AuthenticationServices/Authentication/GetOtp",
            beforeSend: this.sf.setModuleHeaders,
            success: function (data) {
                alert(data);
                $("#txtotp1").focus();
                $('#aGetOtp').fadeOut("slow");
                var distime = 180000;
                if (typeof (vibconstance) !== "undefined") {
                    distime = vibconstance.DisableTime;
                } else {
                    distime = mycardwidgetconstance.DisableTime;
                }
                setTimeout(function () {
                    $('#aGetOtp').fadeIn("slow");
                }, distime);

            },
            error: function () {
            }
        });
    },
    CardModSubmit: function () {
        var otp = $("#txtotp1").val() + $("#txtotp2").val() + $("#txtotp3").val() + $("#txtotp4").val() + $("#txtotp5").val() + $("#txtotp6").val();
        var msg = "";
        if (typeof (vibconstance) !== "undefined") {
            msg = vibconstance.nhapsaiotp;
        } else {
            msg = mycardwidgetconstance.nhapsaiotp;
        }
        if (otp.length != 6) {
            alert(msg);
            return;
        }
        if(dnn.getVar("CurrentPopupAction") == 'VIEWSECRET')
        {
            rbmycard.GetCardSecretInfo(dnn.getVar('CurrentCardView'),otp);
            return;
        }
        $.ajax({
            type: "POST",
            url: this.bsai + "MyCardSubmit",
            data: JSON.stringify({ cardser: dnn.getVar('CurrentCardView'), otp: otp, action: dnn.getVar("CurrentPopupAction") }),
            cache: false,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            beforeSend: this.sf.setModuleHeaders,
            success: (function (data) {
                if (data.IsOTPError && data.IsOTPError == "1") {
                    alert(data.Message);
                    rbmycard.ResetOTP();
                    return;
                }
                var img = "";
                if (typeof (vibconstance) !== "undefined") {
                    img = vibconstance["imgresultpopup" + dnn.getVar("CurrentPopupAction")];
                } else {
                    img = mycardwidgetconstance["imgresultpopup" + dnn.getVar("CurrentPopupAction")];
                }
                $("#divCardModResult img[vib-type='imgresult']").attr("src", img);
                $("#divCardModResult div[vib-type='message']").html(data.Message);
                $.fancybox.close();
                $.fancybox({
                    href: "#divCardModResult",
                    'closeBtn': false,
                    helpers: {
                        overlay: { closeClick: false } //Disable click outside event
                    }
                });
            }),
            error: function (xhr, textStatus, errorThrown) {
                return false;
            }
        });
    },
    GetTransList: function (isrefresh, timetype, dtfrom, dtto, st, fromamt, toamt, period, pageindex) {
        if (dnn.getVar("GetTransListRunning") === "Y" || dnn.getVar("GetTransListDone") === "Y") {
            return;
        }
        dnn.setVar("GetTransListRunning", "Y");
        if (!timetype) {
            timetype = "";
        }
        if (!dtfrom) {
            dtfrom = "";
        }
        if (!dtto) {
            dtto = "";
        }
        if (!st) {
            st = "";
        }
        if (!fromamt) {
            fromamt = "0";
        }
        if (!toamt) {
            toamt = "0";
        }
        if (!period) {
            period = "0";
        }
        if (!pageindex) {
            pageindex = "0";
        }
        dnn.setVar("CurrentSearch_timetype", timetype + "");
        dnn.setVar("CurrentSearch_dtfrom", dtfrom + "");
        dnn.setVar("CurrentSearch_dtto", dtto + "");
        dnn.setVar("CurrentSearch_st", st + "");
        dnn.setVar("CurrentSearch_fromamt", fromamt + "");
        dnn.setVar("CurrentSearch_toamt", toamt + "");
        dnn.setVar("CurrentSearch_period", period + "");
        dnn.setVar("CurrentSearch_pageindex", pageindex + "");
        if (isrefresh) {
            $("#translist").html("");
            var obj= dnn.getVars();
            Object.keys(obj).map(function (key) { 
                //return key; 
                if(key.startsWith("Reloadtrandetail")){
                    dnn.setVar(key,"Y");
                }
            });            
        }
        var dp = {
            timetype: timetype,
            dtfrom: dtfrom,
            dtto: dtto,
            type: dnn.getVar("TRANSHISTTYPE"),
            acctid: dnn.getVar("TRANSHISTACCTID"),
            st: st,
            fromamt: fromamt,
            toamt: toamt,
            period: period,
            pi: pageindex,
        }
        $.ajax({
            type: "GET",
            url: this.bs + "GetTransList",
            data: dp,
            cache: false,
            beforeSend: this.sf.setModuleHeaders,
        }).done(function (data) {
            if (data.STATUSCODE === "000000") {
                $.get(rbmycard.templatefile, null, function (templates) {
                    var pi = dnn.getVar("CurrentSearch_pageindex");
                    if (pi === "0") {
                        dnn.setVar("CurrentSearch_TotalItem", data.TotalRecord + "");
                        $("#divfiltersearch [vib-type='totalrecord']").html(vibconstance.totalrecordfound.replace("{{Total}}", data.TotalRecord));
                        if (data.TotalRecord > 0) {
                            $("#divtranhistfooter [vib-type='footer']").show();
                            $("#divTransactionNoItemContent").hide();
                        } else {
                            rbmycard.ShowEmptyTranHist();
                        }
                    }

                    if (!rbmycard.addtemptobody) {
                        $('body').append(templates);
                        rbmycard.addtemptobody = true;
                    }
                    $("#temprbmycardtranslist").tmpl(data.data).appendTo($("#translist"));
                    $.fancybox.close();
                });
            }

            dnn.setVar("GetTransListRunning", "N");
        });
    },
    TransList_ViewDetail: function (tid) {
        $("div [data-tranid='" + tid +"']").show();
        $("div [data-tranid='" + tid +"']").find(".fl-transaction-quick-view").hide();
        if (dnn.getVar("Reloadtrandetail" + tid) === "N") return;
        var divdetail = $("div [data-tranid='" + tid +"']");
        var dp = {
            tid: tid,
            tidtype: divdetail.attr("tidtype"),
            td: divdetail.attr("trandate"),
            acctid: dnn.getVar("TRANSHISTACCTID"),
            type: dnn.getVar("TRANSHISTTYPE"),
            ccy: divdetail.attr("ccy")
        }
        $.ajax({
            type: "GET",
            url: this.bs + "GetTransDetail",
            data: dp,
            cache: false,
            beforeSend: this.sf.setModuleHeaders,
        }).done(function (res) {
            if (res.STATUSCODE === "000000") {
                dnn.setVar("Reloadtrandetail" + res.data.RowID, "N");
                var divid ="div [data-tranid='" + res.data.RowID +"']";// "#trandetail" + res.data.RowID + " ";
                $(divid + "[vib-type='diengiai']").html(res.data.Desc);
                $(divid + "[vib-type='sohoadon']").html(res.data.TranNo);
                $(divid + "[vib-type='sotien']").html(res.data.strAmount + " " + res.data.CCY);
                $(divid + "[vib-type='ngaythuchien']").html(res.data.strDate);

                $(divid + "[vib-type='tutaikhoan']").html(res.data.FromAcctID + "<br/>" + res.data.FromAcctName);
                var toacctid = "";
                if (res.data.ToAcctID != null) {
                    toacctid = res.data.ToAcctID;
                }
                var toacctname = "";
                if (res.data.ToAcctName != null) {
                    toacctname = res.data.ToAcctName;
                }
                $(divid + "[vib-type='dentaikhoan']").html(toacctid + "<br/>" + toacctname);
                $(divid + "[vib-type='nganhang']").html(res.data.ToBankName);
                $(divid + "[vib-type='tuthe']").html(res.data.FromCardNo);
                var diachi = "";
                var tranmode = $(divid).attr("tranmode");
                if (tranmode === "WITHDRAWAL_ATM" || tranmode === "WITHDRAWAL" || tranmode === "TRANSFER_ATM" || tranmode === "TRANSFER") {
                    diachi = res.data.Address;
                }
                $(divid + "[vib-type='diadiem']").html(diachi);
            }
        });
    },
    HideTranDetail: function (a) {
        $(a).closest("li").find(".fl-transaction-quick-view").show();
        $(a).closest("li").find(".fl-home-transaction-detail").hide();
    },
    AdvanceSearch_Click: function () {
        var timetype = $("#ultimetype .active").attr('vib-data');
        var dtfrom = "", dtto = "", period = "";
        if (timetype === "timeperiod") {
            period = $("#divadvsearch [vib-type='periodvalue'] .active").attr("vib-data");
        }
        if (timetype === "choosedate") {
            dtfrom = $('#txtadvsearchfromdate').val();
            dtto = $('#txtadvsearchtodate').val();
            var f = $('#txtadvsearchfromdate').datepicker("getDate");
            var t = $('#txtadvsearchtodate').datepicker("getDate");
            if (f > t) {
                alert(vibconstance.msgngaytimkiemkhonghople);
                return;
            }
            var minutes = 1000 * 60;
            var hours = minutes * 60;
            var days = hours * 24;
            var totaldays = Math.round((t - f) / days);
            if (totaldays > 31) {
                alert(vibconstance.msgngaytimkiemkhonghople);
                return;
            }
        }
        var st = $("#divadvsearch [vib-type='trancd'] .active").attr("vib-data");
        var fromamt = $('#txtadvsearchfromamt').autoNumeric("get");
        var toamt = $('#txtadvsearchtoamt').autoNumeric("get");
        if (parseFloat(fromamt) > parseFloat(toamt)) {
            alert(vibconstance.msgsotientimkiemkhonghople);
            return;
        }
        rbmycard.GetTransList(true, timetype, dtfrom, dtto, st, fromamt, toamt, period);
        $("#divtransaction-month-slide").hide();
        $("#divfiltersearch").show();
        $("#divfiltersearch [vib-type='filtertype']").html($("#divadvsearch [vib-type='trancd'] .active").text());
        var filterdate = "";
        if (timetype === "choosedate") {
            filterdate = vibconstance.filterdatechoosedate.replace("{{from}}", dtfrom).replace("{{to}}", dtto);// "from " + dtfrom + " to " + dtto;
        } else {
            filterdate = vibconstance.filterdatelastday.replace("{{day}}", period);// "last " + period + " days";
        }
        $("#divfiltersearch [vib-type='filterdate']").html(filterdate);
        var filteramt = "";
        if ((parseFloat(fromamt) !== 0 && fromamt !== "") || parseFloat(toamt) !== 0 && toamt !== "") {
            filteramt = "| " + vibconstance.filteramount.replace("{{from}}", $('#txtadvsearchfromamt').val()).replace("{{to}}", $('#txtadvsearchtoamt').val());// "|  from amount " + $('#txtadvsearchfromamt').val() + " to amount " + $('#txtadvsearchtoamt').val();
        }
        $("#divfiltersearch [vib-type='filteramt']").html(filteramt);

    },
    ExportTranHist: function (filetype) {
        var dp = {
            timetype: dnn.getVar("CurrentSearch_timetype"),
            dtfrom: dnn.getVar("CurrentSearch_dtfrom"),
            dtto: dnn.getVar("CurrentSearch_dtto"),
            type: dnn.getVar("TRANSHISTTYPE"),
            acctid: dnn.getVar("TRANSHISTACCTID"),
            st: dnn.getVar("CurrentSearch_st"),
            fromamt: dnn.getVar("CurrentSearch_fromamt"),
            toamt: dnn.getVar("CurrentSearch_toamt"),
            period: dnn.getVar("CurrentSearch_period"),
            pi: dnn.getVar("CurrentSearch_pageindex"),
            reqtype: "export",
            filetype: filetype
        }
        window.open("/DesktopModules/IBRBController/API/Customer/GetTransList?" + $.param(dp));
        $("#fl-close-tranaction-export").click();
    },
    LoadMoreTranHist: function () {
        var totaltran = parseInt(dnn.getVar("CurrentSearch_TotalItem"));
        if (totaltran <= $("#translist li").length) {
            return;
        }
        var timetype = dnn.getVar("CurrentSearch_timetype");
        var dtfrom = dnn.getVar("CurrentSearch_dtfrom");
        var dtto = dnn.getVar("CurrentSearch_dtto");
        var st = dnn.getVar("CurrentSearch_st");
        var fromamt = dnn.getVar("CurrentSearch_fromamt");
        var toamt = dnn.getVar("CurrentSearch_toamt");
        var period = dnn.getVar("CurrentSearch_period");
        var pageindex = parseInt(dnn.getVar("CurrentSearch_pageindex"));
        rbmycard.GetTransList(false, timetype, dtfrom, dtto, st, fromamt, toamt, period, pageindex + 1);
    },
    PrintTranDetail: function (a) {
        var id = "printdetail" + $.now();

        var divhide = $('<div/>', {
            style: "display:none;"
        });
        var div = $('<div/>', {
            id: id,
        });
        div.appendTo(divhide);
        var divlogo = $('<img/>', {
            src: "/portals/_default/skins/vib-retails/images/VIBlogo.jpg"
        });
        divlogo.appendTo(div);
        $(a).closest(".fl-home-transaction-detail").clone().appendTo(div);
        divhide.appendTo($("body"));
        $("#" + id).printThis({
            debug: false,
            importCSS: true,
            importStyle: true,
            printContainer: true,
            pageTitle: "",
            removeInline: false,
            header: null,
            formValues: true,

        });
    },
    PrintTranHist: function () {
        var id = "printtranlist" + $.now();

        var divhide = $('<div/>', {
            style: "display:none;"
        });
        var div = $('<div/>', {
            id: id,
        });
        div.appendTo(divhide);
        var divlogo = $('<img/>', {
            src: "/portals/_default/skins/vib-retails/images/VIBlogo.jpg"
        });
        divlogo.appendTo(div);
        $("#divtranshisttitle").clone().appendTo(div);
        $("#translist").clone().appendTo(div);
        divhide.appendTo($("body"));
        $("#" + id).printThis({
            debug: false,
            importCSS: true,
            importStyle: true,
            printContainer: true,
            pageTitle: "",
            removeInline: false,
            header: null,
            formValues: true,

        });
    },
    ShowEmptyTranHist: function () {
        $("#translist").html("");
        $("#divtranhistfooter [vib-type='footer']").hide();
        $("#divTransactionNoItemContent").show();
    },
    change_height_other_card_div: function () {
        var height = $(".fl-mycard-content-card-right").height();
        height = height - $(".fl-mycard-card-primary").height();
        height = height - $(".fl-mycard-primary-title").height() - 76;
        if (height > 150) {
            $(".fl-mycard-supplementary-content").css("height", height);
        }
    },
    GetTranHistType: function () {
        return dnn.getVar("TRANSHISTTYPE");
    },
    Widget_GetInfo: function (cardser) {
        dnn.setVar('WidgetCurrentCardView', cardser);
        if (dnn.getVar('WidgetCardLoad' + cardser) === "Y") {
            var divitem = $("#divcardwidgetitem div.fl-mycar-right-item[vib-value='" + cardser + "']");
            $("#amycardwidgetdetail").attr("href", $(divitem).attr("vib-url"));
            return;
        }
        $.ajax({
            type: "GET",
            url: this.bsai + "MyCardInfo",
            data: { id: cardser },
            cache: false,
            beforeSend: this.sf.setModuleHeaders,
        }).done(function (data) {
            if (data.StatusCode === "000000") {
                var currentcardser = dnn.getVar('WidgetCurrentCardView');
                var divitem = $("#divcardwidgetitem div.fl-mycar-right-item[vib-value='" + currentcardser + "']");
                dnn.setVar('WidgetCardLoad' + currentcardser, "Y");
                dnn.setVar("CARDDELIVERED_"+currentcardser, data.DELIVERED);
                dnn.setVar("ECOMMERCED_"+currentcardser, data.ECOMMERCED);
                dnn.setVar("SALEENABLED_"+currentcardser, data.SALEENABLED);
                $("#amycardwidgetdetail").attr("href", $(divitem).attr("vib-url"));
                var _aLock = $(divitem).find("a[vib-type='aLock']");
                var _aecom = $(divitem).find("a[vib-type='aecom']");
                var _aactive = $(divitem).find("a[vib-type='aactive']");
                $(_aLock).removeClass("disabled").removeAttr("vib-action");
                $(_aecom).removeClass("disabled").removeAttr("vib-action");

                if (divitem.attr("vib-primary") == "true") {
                    $(divitem).find("a[vib-type='cardismain']").html(mycardwidgetconstance.txtTheChinh + "/" + data.strStatus);
                } else {
                    $(divitem).find("a[vib-type='cardismain']").html(mycardwidgetconstance.txtThePhu + "/" + data.strStatus);
                }
                if (data.SHOW_ECOMMERCE) {
                    $(_aecom).show();
                } else {
                    $(_aecom).hide();
                }
                if (data.SHOW_LOCK) {
                    $(_aLock).show();
                } else {
                    $(_aLock).hide();
                }
                //$("#divContent").removeClass("card-actived").removeClass("card-disabled");
                if (data.ACTIVED === "N") {
                    //console.log($(divitem).find("a[vib-type='cardinfo']"));
                    $(divitem).find("[vib-type='cardinfo']").hide();
                    $(divitem).find("[vib-type='activeinfo']").show();
                    $(_aLock).addClass("disabled");
                    $(_aecom).addClass("disabled");
                    //$(_aactive).addClass("disabled");
                    $(divitem).addClass("fl-card-unactive");
                    if(data.DELIVERED != "Y" && data.OTPREGISTERED !="Y"){
                        $(_aactive).addClass("disabled");
                    }
                    else{
                       $(_aactive).click(function () {
                        if (!$(this).hasClass("disabled")) {
                            dnn.setVar("CurrentPopupAction", "ACTIVE");
                            dnn.setVar('CurrentCardView', currentcardser);
                            rbmycard.Widget_aActive_click();
                            }
                         }); 
                    }
                    

                } else {
                    $(divitem).find("[vib-type='cardinfo']").show();
                    $(divitem).find("[vib-type='activeinfo']").hide();
                    $(_aLock).removeClass("disabled");
                    $(_aecom).removeClass("disabled");
                    $(_aactive).removeClass("disabled");
                    $(divitem).removeClass("fl-card-unactive");
                    //$("#divContent").addClass("card-actived");
                }

                if (data.ECOMMERCED === "Y") {
                    $(_aecom).html(mycardwidgetconstance.aDISEommerce).attr("vib-action", "DISECOM");
                } else {
                    $(_aecom).html(mycardwidgetconstance.aECommerce).attr("vib-action", "ENECOM");
                }
                if (data.LOCKED === "Y") {
                    $(_aLock).html(mycardwidgetconstance.aUnLock).attr("vib-action", "UNLOCK");
                    $(_aecom).addClass("disabled");
                } else {
                    $(_aLock).html(mycardwidgetconstance.aLock).attr("vib-action", "LOCK");
                }


                if (!data.Enable) {
                    $(divitem).addClass("fl-card-unactive");
                    $(_aLock).addClass("disabled");
                    $(_aecom).addClass("disabled");
                    $(_aactive).addClass("disabled");
                }
                //else {
                //    $(divitem).removeClass("fl-card-unactive");
                //    $(_aLock).removeClass("disabled");
                //    $(_aecom).removeClass("disabled");
                //    $(_aactive).removeClass("disabled");
                //}

                if (data.IsDigi) {
                    $(".fl-mycard-info").hide();
                    $(".fl-mycard-digi-note").show();
                    $('.fl-mycard-right .fl-mycard-right-slide img:visible').css('height', '252px');
                } else {
                    $(".fl-mycard-info").show();
                    $(".fl-mycard-digi-note").hide();
                    $('.fl-mycard-right .fl-mycard-right-slide img:visible').removeAttr('style');
                }

                $(_aLock).click(function () {
                    if (!$(_aLock).hasClass("disabled")) {
                        rbmycard.Widget_aLockClick(currentcardser, $(this).attr("vib-action"));
                    }
                });

                $(_aecom).click(function () {

                    if (!$(_aecom).hasClass("disabled")) {
                        rbmycard.Widget_aEcomClick(currentcardser, $(this).attr("vib-action"));
                    }
                });

            }
        });
    },
    Widget_aLockClick: function (cardser, action) {
        var divitem = $("#divcardwidgetitem div.fl-mycar-right-item[vib-value='" + cardser + "']");
        dnn.setVar("CurrentPopupAction", action);
        dnn.setVar('CurrentCardView', cardser);
        rbmycard.ResetOTP();
        $("#divPopupCardMod img[vib-type='imgcard']").attr("src", divitem.find("img[vib-type='cardimg']").attr("src"));
        $("#divPopupCardMod div[vib-type='cardname']").html(divitem.find("div[vib-type='cardname']").html());
        $("#divPopupCardMod div[vib-type='cardno']").html(divitem.find("div[vib-type='cardno']").html());
        $("#divPopupCardMod div[vib-type='producttype']").html(divitem.find("div[vib-type='loaithe']").html());
        $("#divPopupCardMod div[vib-type='message']").html("").hide();
        $("#divPopupCardMod div[vib-type='messagetop']").html(mycardwidgetconstance["msgConfirm" + action]).show();
        $("#aPopupCardModNext").html(mycardwidgetconstance["txtaPopupNext" + action]);
        $.fancybox({
            href: "#divPopupCardMod",
            helpers: {
                overlay: { closeClick: false } //Disable click outside event
            }
        });
    },
    Widget_aEcomClick: function (cardser, action) {
        var esale =dnn.getVar("SALEENABLED_"+ cardser);
        if(esale =="N" && action=="DISECOM"){
            $("#divCardMessagePopup span[data-vibkey='popupmsg']").html(vibconstance.msgErrorOnlySALE);
            $.fancybox({
            href: "#divCardMessagePopup",
            helpers: {
                overlay: { closeClick: false } //Disable click outside event
            }
            });
        }
        else{
            //var divitem = $("#divcardwidgetitem div.fl-mycar-right-item[vib-value='" + cardser + "']");
            dnn.setVar("CurrentPopupAction", action);
            dnn.setVar('CurrentCardView', cardser);
            rbmycard.ResetOTP();
            $("#divPopupCardMod img[vib-type='imgcard']").attr("src", mycardwidgetconstance.imgConfirmECOM);
            $("#divPopupCardMod div[vib-type='cardname']").html("");
            $("#divPopupCardMod div[vib-type='cardno']").html("");
            $("#divPopupCardMod div[vib-type='producttype']").html("");
            $("#divPopupCardMod div[vib-type='message']").html(mycardwidgetconstance["msgConfirm" + action]).show();
            $("#divPopupCardMod div[vib-type='messagetop']").html("").hide();
            $("#aPopupCardModNext").html(mycardwidgetconstance["txtaPopupNext" + action]);
            $.fancybox({
                href: "#divPopupCardMod",
                helpers: {
                    overlay: { closeClick: false } //Disable click outside event
                }
            });
            }
    },
    Widget_aActive_click: function () {
        //if (!confirm(vibconstance.msgActivedWarning)) return;
        rbmycard.ResetOTP();
        var divitem = $("#divcardwidgetitem div.fl-mycar-right-item[vib-value='" + dnn.getVar('CurrentCardView') + "']");
        $("#divPopupCardMod img[vib-type='imgcard']").attr("src", divitem.find("img[vib-type='cardimg']").attr("src"));
        $("#divPopupCardMod div[vib-type='cardname']").html(divitem.find("div[vib-type='cardname']").html());
        $("#divPopupCardMod div[vib-type='cardno']").html(divitem.find("div[vib-type='cardno']").html());
        $("#divPopupCardMod div[vib-type='producttype']").html(divitem.find("div[vib-type='loaithe']").html());
        $("#divPopupCardMod div[vib-type='message']").html(mycardwidgetconstance["msgConfirm" + dnn.getVar("CurrentPopupAction")]).show();
        $("#divPopupCardMod div[vib-type='messagetop']").html("").hide();
        $("#aPopupCardModNext").html(mycardwidgetconstance["txtaPopupNext" + dnn.getVar("CurrentPopupAction")]);
        $.fancybox({
            href: "#divPopupCardMod",
            helpers: {
                overlay: { closeClick: false } //Disable click outside event
            }
        });
    },
    GetCardSecretInfo: function (cardser,otp) {        
        $.ajax({
            type: "GET",
            url: this.bsai + "MyCardSecretInfo",
            data: { id: cardser, otp: otp },
            cache: false,
            beforeSend: this.sf.setModuleHeaders,
        }).done(function (data) {
            if (data.STATUSCODE === "000000") {                
                $("#divCardSecretPopup img[data-vib='imgcardsecretpopup']").attr("src", $("#divSelectedCard img[vib-type='cardimg']").attr("src"));
                $("#divCardSecretPopup span[data-vib='cardsecretcardno']").html(data.CardNo);
                $("#divCardSecretPopup span[data-vib='cardsecretexpvalue']").html(data.ExpiredDate);
                $("#divCardSecretPopup span[data-vib='cardsecretcvvvalue']").html(data.CVV);
                $.fancybox.close();
                $.fancybox({
                    href: "#divCardSecretPopup",
                    'closeBtn': true,
                    helpers: {
                        overlay: { closeClick: false } //Disable click outside event
                    }
                });
                setTimeout("parent.$.fancybox.close()", 300000);
                $("#divCardSecretPopup").closest("div.fancybox-skin").css("background","none");
            }
            else{
                alert(data.MESSAGE);
            }
        });
    },
    aviewsecret_click: function () {        
        $.fancybox({
            href: "#divPopupOTP",
            helpers: {
                overlay: { closeClick: false } //Disable click outside event
            }
        });
    },
    asale_click: function () {
        var ecom =dnn.getVar("ECOMMERCED_"+ dnn.getVar("CurrentCardView"));
        if(ecom =="N" && dnn.getVar("CurrentPopupAction")=="DISSALE"){
            $("#divMessagePopup span[data-vibkey='popupmsg']").html(vibconstance.msgErrorOnlyECOM);
            $.fancybox({
            href: "#divMessagePopup",
            helpers: {
                overlay: { closeClick: false } //Disable click outside event
            }
            });
        }
        else{
            $("#divPopupCardMod img[vib-type='imgcard']").attr("src", vibconstance.imgConfirmSALE);
            $("#divPopupCardMod div[vib-type='cardno']").html("");
            $("#divPopupCardMod div[vib-type='producttype']").html("");
            $("#divPopupCardMod div[vib-type='message']").html(vibconstance["msgConfirm" + dnn.getVar("CurrentPopupAction")]).show();
            $("#divPopupCardMod div[vib-type='messagetop']").html("").hide();
            $("#aPopupCardModNext").html(vibconstance["txtaPopupNext" + dnn.getVar("CurrentPopupAction")]);
            $.fancybox({
            href: "#divPopupCardMod",
            helpers: {
                overlay: { closeClick: false } //Disable click outside event
            }
            });
        }
        
    },
}

var jsbanner = {
    sf: null,
    bs: null,
    Init: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('GalleryController') + 'Customer/';
    },
    Load: function () {
        $.ajax({
            type: "GET",
            url: this.bs + "GetImage",
            beforeSend: this.sf.setModuleHeaders,
            //data: datap,
            success: function (result) {
                if (typeof result != "undefined" && result != null) {
                    if (result.STATUSCODE !== "000000") {
                        return;
                    }
                    if (result.data == null) return;
                    switch (result.Type) {
                        case 2:

                            break;
                        case 1:
                        case 3:
                            $.each(result.data, function (index, item) {
                                if (item.Url.trim() != "") {
                                    var img = $("<img/>",
                                        {
                                            src: item.FilePath
                                        }
                                    );
                                    var a = $("<a/>", {
                                        href: item.Url
                                    });
                                    img.appendTo(a);
                                    jsbanner.append_banner(a);
                                } else {

                                    var img = $("<img/>",
                                        {
                                            src: item.FilePath,
                                            usemap: "#imagemap_" + item.MediaId
                                        }
                                    );
                                    var map = $("<map/>", {
                                        id: "imagemap_" + item.MediaId,
                                        name: "imagemap_" + item.MediaId,
                                    });
                                    if (item.ImageMaps != null) {
                                        $.each(item.ImageMaps, function (i, area) {
                                            var areaitem = $("<area/>", {
                                                href: area.Href,
                                                shape: area.Shape,
                                                coords: area.Coords,
                                                target: area.Target
                                            });
                                            areaitem.appendTo(map);
                                        });
                                    }
                                    map.appendTo($("body"));
                                    jsbanner.append_banner(img);
                                }
                            });

                            jQuery_1_11_1("#fl_banner_slide").owlCarousel({
                                autoPlay: true,
                                items: 1,
                                mouseDrag: true,
                                pagination: true,
                                navigation: true,
                                animateOut: 'fadeOut',
                                afterMove: function (elem) {

                                }
                            });

                            break;
                    }

                }
            }
        });
    },
    append_banner: function (img, cssclass, appendto) {
        var div = $('<div/>', {
            class: cssclass
        });
        img.appendTo(div);
        div.appendTo(appendto);
    }
}

var skin2columnpageload = {
    sf: null,
    bs: null,
    bsgallery: null,
    Init: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('IBRBController') + 'Customer/';
        this.bsgallery = this.sf.getServiceRoot('GalleryController') + 'Customer/';
    },
    PageLoad: function () {
        skin2columnpageload.ShowUserInfo();
        skin2columnpageload.LoadBanner();
        GenLiveChatSection();
    },
    ShowUserInfo: function () {
        var lang = document.documentElement.lang;
        var info = skin2columnpageload.GetCookie("VIBN8Cp6Sa9OI");
        var infoArr = info.split("{|}");
        if ($("#divheaderuserinfo") && infoArr.length == 4) {
            if (lang == "vi-VN") {
                $("#divheaderuserinfo .fl-account-header-title").html(decodeURI(infoArr[1]));
                $("#divheaderuserinfo [vib-type='lastlogin']").html(decodeURI(infoArr[0]));
            }
            else if (lang == "en-US") {
                $("#divheaderuserinfo .fl-account-header-title").html(decodeURI(infoArr[3]));
                $("#divheaderuserinfo [vib-type='lastlogin']").html(decodeURI(infoArr[2]));
            }
        }
        
        //$.ajax({
        //    type: "GET",
        //    url: this.bs + "CurrentUser",
        //    beforeSend: this.sf.setModuleHeaders,
        //    cache: false,
        //    success: function (result) {
        //        if (result.STATUSCODE === "000000") {
        //            if ($("#divheaderuserinfo")) {
        //                $("#divheaderuserinfo .fl-account-header-title").html(result.HeaderTitle);
        //                $("#divheaderuserinfo [vib-type='lastlogin']").html(result.LastLogin);
        //            }
        //        }
        //    }
        //});

    },
    GetCookie: function (cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";            
    },
    LoadBanner: function () {
        var datap = {
            TabID: dnn.getVar("sf_tabId"),
            Position: "RIGHT"
        };
        $.ajax({
            type: "GET",
            url: this.bsgallery + "GetImage",
            beforeSend: this.sf.setModuleHeaders,
            data: datap,
            success: function (result) {
                if (typeof result != "undefined" && result != null) {
                    if (result.STATUSCODE !== "000000") {
                        return;
                    }
                    if (result.data == null) return;
                    switch (result.Type) {
                        case 2:

                            break;
                        case 1:
                        case 3:
                            $.each(result.data, function (index, item) {
                                if (item.Url.trim() != "") {
                                    var img = $("<img/>",
                                        {
                                            src: item.FilePath
                                        }
                                    );
                                    var a = $("<a/>", {
                                        href: item.Url,
                                        //class: "item"
                                    });
                                    img.appendTo(a);
                                    skin2columnpageload.append_banner(a, "item", "#fl-ads-box-right");
                                } else {

                                    var img = $("<img/>",
                                        {
                                            src: item.FilePath,
                                            usemap: "#imagemap_" + item.MediaId,
                                            //class: "item"
                                        }
                                    );
                                    var map = $("<map/>", {
                                        id: "imagemap_" + item.MediaId,
                                        name: "imagemap_" + item.MediaId,
                                    });
                                    if (item.ImageMaps != null) {
                                        $.each(item.ImageMaps, function (i, area) {
                                            var areaitem = $("<area/>", {
                                                href: area.Href,
                                                shape: area.Shape,
                                                coords: area.Coords,
                                                target: area.Target
                                            });
                                            areaitem.appendTo(map);
                                        });
                                    }
                                    map.appendTo($("body"));
                                    skin2columnpageload.append_banner(img, "item", "#fl-ads-box-right");
                                }
                            });

                            jQuery_1_11_1("#fl-ads-box-right").owlCarousel({
                                autoPlay: true,
                                items: 1,
                                mouseDrag: true,
                                pagination: true,
                                navigation: false,
                                animateOut: 'fadeOut',
                                responsive: false,
                                afterMove: function (elem) {

                                }

                            });

                            break;
                    }

                }
            }
        });
    },
    append_banner: function (img, cssclass, appendto) {
        var div = $('<div/>', {
            class: cssclass
        });
        img.appendTo(div);
        div.appendTo(appendto);
    }
}

var rbinbox = {
    sf: null,
    bs: null,
    InitWidget: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('Inbox2Controller') + 'Customer/';
        dnn.setVar("INBOXWIDGETPI", "1");
        $("#ucwidgetinbox [vib-type='viewmore']").click(function () {
            var pi = parseInt(dnn.getVar("INBOXWIDGETPI"));
            dnn.setVar("INBOXWIDGETPI", (pi + 1).toString());
            if (dnn.getVar("INBOXWIDGETALL") === "Y") {
                rbinbox.LoadWidget();
            } else {
                rbinbox.WidgetLoadAllMsg();
            }
        });
        rbinbox.LoadWidget();
    },
    LoadWidget: function () {
        $("#widgetinboxlist").html("");
        var datap = {
            TabID: dnn.getVar("sf_tabId"),
            key: "WIDGET",
            pi: dnn.getVar("INBOXWIDGETPI")
        };
        $.ajax({
            type: "GET",
            cache: false,
            url: this.bs + "GetUnreadHome",
            beforeSend: this.sf.setModuleHeaders,
            data: datap,
            success: function (result) {
                if (result.STATUSCODE !== "000000") {
                    return;
                }
                if (result.totalrecord === 0) {
                    rbinbox.WidgetLoadAllMsg();
                    dnn.setVar("INBOXWIDGETALL", "Y");
                    return;
                }
                $("#ucwidgetinbox [vib-type='totalrecord']").html(inboxwidget.totalrecord.replace("{{total}}", result.totalrecord));
                $("#ucwidgetinbox").show();
                $.get(templatefile, null, function (templates) {
                    if (!templatefileaddtemptobody) {
                        $('body').append(templates);
                        templatefileaddtemptobody = true;
                    }
                    $("#temprbinboxwidget").tmpl(result.data).appendTo($("#widgetinboxlist"));
                });
                var itemview = parseInt(dnn.getVar("INBOXWIDGETPI")) * result.PageSize;
                if (itemview >= result.totalrecord) {
                    $("#ucwidgetinbox [vib-type='viewmore']").hide();
                }
            },
        });
    },
    WidgetLoadAllMsg: function () {
        $("#widgetinboxlist").html("");
        dnn.setVar("INBOXWIDGETALL", "Y");
        var datap = {
            pageindex: dnn.getVar("INBOXWIDGETPI"),
            cateid: "",
            status: "",
            ps: 3
        };
        $.ajax({
            type: "GET",
            cache: false,
            url: this.bs + "Gets",
            beforeSend: this.sf.setModuleHeaders,
            data: datap,
            success: function (result) {
                if (result.STATUSCODE !== "000000") {
                    return;
                }
                $("#ucwidgetinbox [vib-type='totalrecord']").hide();
                //$("#ucwidgetinbox [vib-type='totalrecord']").html(result.totalrecord);
                //$("#ucwidgetinbox [vib-type='totalrecord']").html(inboxwidget.totalrecord.replace("{{total}}", result.totalrecord));
                if (result.totalrecord === 0) {
                    return;
                }
                $("#ucwidgetinbox").show();
                $.get(templatefile, null, function (templates) {
                    if (!templatefileaddtemptobody) {
                        $('body').append(templates);
                        templatefileaddtemptobody = true;
                    }
                    $("#temprbinboxwidget").tmpl(result.data).appendTo($("#widgetinboxlist"));
                });
                var itemview = parseInt(dnn.getVar("INBOXWIDGETPI")) * result.PageSize;
                if (itemview >= result.totalrecord) {
                    $("#ucwidgetinbox [vib-type='viewmore']").hide();
                }
            },
        });
    }
}

function GenLiveChatSection() {
    var text = "Hỗ trợ trực tuyến";
    if ($("html").attr("en-US")) {
        text = "Live chat";
    }
    $('body').append('<section class="live-chat-box minimize"><header class="header clearfix"><a href="javascript:;" class="clearfix show-live-chat bar"><i class="pull-left icon icon--mesage"></i><span class="pull-left">' + text + '</span></a><a href="javascript:;" class="pull-right icon icon--minus minimize-btn "></a>     </header> </section>');
    $('.live-chat-box.minimize').click(function (e) {
        if ($("html").attr("en-US")) {
            window.open("https://vib1.custhelp.com/app/chat/chat_launch", 'name', 'width=600,height=500,scrollbars=no');
        } else {
            window.open("https://vib.custhelp.com/app/chat/chat_launch", 'name', 'width=600,height=500,scrollbars=no');
        }

    });
}

var tips = {
    sf: null,
    bs: null,
    Init: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('VIBEbank') + 'Ebank/';
    },
    InitTip: function () {

        $(".fl-tip-search-text").keyup(function () {
            var key = $(this).val();
            tips.SearchTip(key);
        });
        $(".fl-tips-suggest-containt .fl-icon-close").click(function () {
            $(".fl-tip-search-text").val("");
            $(".fl-tips-suggest-box").addClass("hidden");
            $(".fl-tips-search-group").css("z-index", 2);
            $(".fl-tips-suggest-box").addClass("hidden");
            $("body").find(".fl_bg_overlay").remove();
        });

    },
    TipHome: function () {
        var datap = {
            listSize: 10
        };
        $.ajax({
            type: "GET",
            cache: false,
            url: this.bs + "GetListTips",
            beforeSend: this.sf.setModuleHeaders,
            data: datap,
            success: function (result) {
                if (result.data != null) {
                    $(".fl-tips-list ul").html("");
                    $.each(result.data, function (index, n) {
                        $(".fl-tips-list ul").append('<li><a href="' + n.Url + '"><b>' + n.Priority + '. </b>' + n.Title + '</a></li>');
                    });
                } else {

                }
            },
            error: function (jqXHR, textStatus) {
            }
        });
    },
    TipDetail: function (idTip) {
        var datap = {
            listSize: 10
        };
        $.ajax({
            type: "GET",
            cache: false,
            url: this.bs + "GetListTips",
            beforeSend: this.sf.setModuleHeaders,
            data: datap,
            success: function (result) {
                if (result.data != null) {
                    $(".fl-tips-resent-right-box ul").html("");
                    $.each(result.data, function (index, n) {
                        $(".fl-tips-resent-right-box ul").append('<li><a href="' + n.Url + '">' + n.Title + '</a></li>');
                    });
                } else {

                }
            },
            error: function (jqXHR, textStatus) {
                // alert(jqXHR.responseText.trim());
            }
        });

        //lay tip detail

        if (idTip != undefined && idTip != "") {
            var data1 = {
                idTip: idTip
            };
            $.ajax({
                type: "GET",
                cache: false,
                url: this.bs + "GetTipDetail",
                beforeSend: this.sf.setModuleHeaders,
                data: data1,
                success: function (result) {
                    if (result.url != null && result.url != "" && result.url != undefined) {
                        window.location.href = result.url;
                    } else {
                        if (result.data != null) {
                            $(".fl-tips-cat-title").text(result.data.Priority + '. ' + result.data.Title);
                            $(".fl-tips-content-detail").append(result.data.Content);

                            //lay nut chuyen						                        

                            var data2 = {
                                priority: result.data.Priority
                            };
                            tips.GetTipByNearPriority(data2);

                        } else {
                            $(".fl-tips-cat-title").text("Đường dẫn này không tồn tại");
                        }
                    }
                },
                error: function (jqXHR, textStatus) {
                    //alert(jqXHR.responseText.trim());
                }
            });
        }

    },
    GetTipByNearPriority: function (data) {
        $.ajax({
            type: "GET",
            cache: false,
            url: this.bs + "GetTipByNearPriority",
            beforeSend: this.sf.setModuleHeaders,
            data: data,
            success: function (result) {
                if (result.TipPrev != null) {
                    $(".fl-tips-detail-bottom").append('<a href="' + result.TipPrev.Url + '" class="fl-tips-detail-left"><b>' + result.TipPrev.Priority + '. </b>' + result.TipPrev.Title + '</a>');
                }
                if (result.TipNext != null) {
                    $(".fl-tips-detail-bottom").append('<a href="' + result.TipNext.Url + '" class="fl-tips-detail-right"><b>' + result.TipNext.Priority + '. </b>' + result.TipNext.Title + '</a>');
                }
            },
            error: function (jqXHR, textStatus) {
                // alert(jqXHR.responseText.trim());
            }
        });
    },

    SearchTip: function (key) {
        if (key != '' && key != ' ') {
            if (!$("body").find(".fl_bg_overlay").length) {
                $("body").append('<div class="fl_bg_overlay"></div>');
                $(".fl-tips-suggest-box").css("z-index", 9999);
                $(".fl-tips-search-group").css("z-index", 9999);
            }
            $(".fl-tips-suggest-box").removeClass("hidden");

            //search ajax
            var datas = {
                key: key
            };
            $.ajax({
                type: "GET",
                cache: false,
                url: this.bs + "SearchTips",
                beforeSend: this.sf.setModuleHeaders,
                data: datas,
                success: function (result) {
                    $(".fl-tips-suggest-number").text("");
                    $("#fl-tips-suggest-content").html("");
                    if (result.data != null && result.TotalRecord > 0) {
                        //<span class="fl-tips-suggest-number">(4) result</span>
                        if (result.TotalRecord == 1) {
                            $(".fl-tips-suggest-number").text(result.TotalRecord + strResult);
                        } else {
                            $(".fl-tips-suggest-number").text(result.TotalRecord + strResults);
                        }

                        $.each(result.data, function (index, n) {
                            //<a href="#"><span class="fl-suggest-hilight">Savvings</span></a>
                            //var string = "foo",
                            //substring = "oo";
                            //console.log(string.indexOf(substring) !== -1);
                            if (n.Title.indexOf(key) !== -1) {
                                //title không có từ khóa
                                $("#fl-tips-suggest-content").append('<a href="' + n.Url + '">' + n.Title.replace(key, "<span class='fl-suggest-hilight'>" + key + "</span>") + '</a>');
                            } else {
                                var contentArr = n.ContentShow.split(".");
                                $.each(contentArr, function (index, m) {
                                    if (m.indexOf(key) !== -1) {
                                        //có từ khóa
                                        $("#fl-tips-suggest-content").append('<a href="' + n.Url + '">' + m.replace(key, "<span class='fl-suggest-hilight'>" + key + "</span>") + '</a>');
                                    }
                                });
                            }
                        });

                    } else {
                        $(".fl-tips-suggest-number").text(strNoResult);
                    }
                },
                error: function (jqXHR, textStatus) {
                    //alert(jqXHR.responseText.trim());
                }
            });

        } else {
            $(".fl-tips-search-group").css("z-index", 2);
            $(".fl-tips-suggest-box").addClass("hidden");
            $("body").find(".fl_bg_overlay").remove();
        }
    },
}
var rbcardstatement = {
    sf: null,
    bs: null,
    Init: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        //this.bs = this.sf.getServiceRoot('RBAccountInformation') + 'WebAPI/';
        this.bs = this.sf.getServiceRoot('IBRBController') + 'Customer/';
    },
    InitLoad: function () {
        $(".btn-back-card").attr("href", dnn.getVar("UrlMyCard"));
        ///
        $('.fancy').fancybox();////

        var email = dnn.getVar("EmailUser");
        if (email != undefined && email != "") {
            $('#pEmailUser').text(email);
        } else {
            $('.email').addClass('hidden');
        }
        $('.nlg-list-month li').click(function () {
            $('.nlg-list-month li').removeClass("active");
            $(this).addClass("active");
            //var dateRp = $(".nlg-list-month li.active").html();
            var dateRp = $(".nlg-list-month li.active").attr("vib-date");
            dnn.setVar("dateRp", dateRp);
            rbcardstatement.GetCardStatement();

            var monthY = $(".nlg-list-month li.active").html();
            if (monthY.indexOf("/") != -1) {
                var month = parseInt(monthY.substring(0, 2));
                monthY = month + monthY.substring(2, 7);
            }
            $("#spMonth").html(monthY);
        });
        ///
        $('.mail_box_nlg a').click(function () {
            rbcardstatement.SendEmailCardStatement();
        });

        ///
        $("#fl-icon-export").click(function () {
            $("#fl-tranaction-export").toggleClass('hidden', 'slow');
            rbcardstatement.ExportCardStatement();
        });
        $("#fl-close-tranaction-export").click(function () {
            $("#fl-tranaction-export").toggleClass('hidden', 'slow');
        });
        $(".fl-tranaction-export-popup").click(function () {
            $("#fl-tranaction-export").toggleClass('hidden', 'slow');
        });
        $(".fl-tranaction-export-popup").click(function () {
            $("#fl-tranaction-export").toggleClass('hidden', 'slow');
        });

        $("#btnPrint").click(function() {
            rbcardstatement.PrintCardStatement();
        });

        var dateRp_ = $(".nlg-list-month li.active").attr("vib-date");
        var monthY_ = $(".nlg-list-month li.active").html();
        if (monthY_.indexOf("/") != -1) {
            var month = parseInt(monthY_.substring(0, 2));
            monthY_ = month + monthY_.substring(2, 7);
        }
        $("#spMonth").html(monthY_);
        dnn.setVar("dateRp", dateRp_);
        rbcardstatement.GetCardStatement();

    },
    GetCardStatement: function () {
        var datas = {
            id: dnn.getVar("CardID"),
            dateRp: dnn.getVar("dateRp"),
            type: "Report"
        };

        $("#tbl-debit").empty();
        $("#tbl-credit").empty();
        $("#fl-icon-export").addClass("a-not-active");
        $("#btnPrint").addClass("a-not-active");
        $("#btnSendEmail").addClass("a-not-active");


        $.ajax({
            type: "GET",
            cache: true,
            url: this.bs + "GetCardStatement",
            beforeSend: this.sf.setModuleHeaders,
            data: datas,
            success: function (result) {
                $("#tbl-debit").empty();
                $("#tbl-credit").empty();
                $("#fl-icon-export").addClass("a-not-active");
                $("#btnPrint").addClass("a-not-active");
                $("#btnSendEmail").addClass("a-not-active");
                var data = result.data;
                if (result.STATUSCODE == "000000") {
                    if (data != null) {
                        $("#fl-icon-export").removeClass("a-not-active");
                        $("#btnPrint").removeClass("a-not-active");
                        $("#btnSendEmail").removeClass("a-not-active");

                        //$("#spMonth").html(data.)
                        $("#spOpenbal").html(data.OpenBalLimitStr + " " + data.Ccy);
                        $("#spTotaldebit").html(data.TotalDebitStr + " " + data.Ccy);
                        $("#spTotalCredit").html(data.TotalCreditStr + " " + data.Ccy);
                        $("#spClosingbal").html(data.ClosingBalStr.replace("-", "") + " " + data.Ccy);
                        $("#spTotalDebitTrans").html("(" + data.TotalCreditTrans + ")");

                        //xu ly debit
                        if (data.TotalDebitTrans > 0) {
                            var oldCard = "";
                            if (data.TransListDebit != null) {
                                $.each(data.TransListDebit, function (index, item) {
                                    if (item.Tran_Type == "CR") {
                                        var debittrans = templateDebit.replace("{{Date}}", item.TranDateStr).replace("{{TranDesc}}", item.TranDesc)
                                           // .replace("{{FromAcct}}", item.SrcNumber)
                                            .replace("{{CCY}}", data.Ccy)
                                            .replace("{{Amount}}", item.TranAmountStr).replace("{{TranType}}", item.Tran_Type);
                                        $("#tbl-debit").append(debittrans);
                                    }
                                });
                            }
                        }

                        //xu ly credit
                        if (data.TotalCreditTrans > 0) {
                            var oldCard = "";
                            if (data.TransListCredit != null) {
                                $.each(data.TransListCredit, function (i, n) {
                                    $.each(n.TransactionCredit, function (index, item) {
                                        if (oldCard != item.SrcNumber) {
                                            var templateCard = templateTranCreditCard.replace("{{FromCard}}", item.SrcNumber)
                                                .replace("{{Amount}}", n.TotalAmtCreditCardStr).replace("{{CCY}}", data.Ccy);
                                            $("#tbl-credit").append(templateCard);
                                        }
                                        var org = "";
                                        if (data.Ccy != item.TranCcy) {
                                            org = " (" + item.OrginalAmt + " " + item.TranCcy + ")";
                                        }
                                        var credittrans = templateCredit.replace("{{Date}}", item.TranDateStr).replace("{{MeChant}}", item.meChantName.trim() == "," ? item.TranDesc : item.meChantName)
                                            .replace("{{Amount}}", item.TranAmountStr + " " + data.Ccy + org);
                                        $("#tbl-credit").append(credittrans);
                                        oldCard = item.SrcNumber;
                                    });
                                });
                            }
                        }


                        if (data.TotalCreditTrans == 0) {
                            $("#tbl-credit").append(noTrans);
                        } else {
                            //$("#spCredit").html(data.TotalCreditStr);
                        }
                        if (data.TotalDebitTrans == 0) {
                            $("#tbl-debit").append(noTrans);
                        }

                        $("#spTotalCreditTrans").html("(" + data.TotalCreditTrans + ")");
                        $("#spTotalDebitTrans").html("(" + data.TotalDebitTrans + ")");


                        var fFoundOther = false;
                        if (data.TotalCreditTrans > 0 && data.TransListDebit != null) {
                            var oldCard = "";
                            if (data.TransListDebit != null) {
                                $.each(data.TransListDebit, function (index, item) {
                                    if (item.Tran_Type == "DR") {
                                        if (!fFoundOther) {
                                            var templateOther = templateOtherCredit.replace("{{Amount}}", data.TotalOtherAmtStr).replace("{{CCY}}", data.Ccy);
                                            $("#tbl-credit").append(templateOther);
                                        }
                                        var debittrans = templateDebit.replace("{{Date}}", item.TranDateStr).replace("{{TranDesc}}", item.TranDesc)
                                          //  .replace("{{FromAcct}}", item.SrcNumber)
                                            .replace("{{Amount}}", item.TranAmountStr)
                                            .replace("{{CCY}}", data.Ccy).replace("{{TranType}}", "");
                                        $("#tbl-credit").append(debittrans);
                                        fFoundOther = true;
                                    }
                                });
                            }
                        }
                        if (!fFoundOther) {
                            $("#tbl-credit").append(templateOtherCredit.replace("{{Amount}}", "")
                                            .replace("{{CCY}}", ""));
                            $("#tbl-credit").append(noTrans);
                        }

                    }
                } else if (result.StatusCode == "500005") {
                    $("#tbl-credit").append(noTrans);
                    $("#tbl-debit").append(noTrans);
                    $("#spTotalCreditTrans").html("");
                    $("#spTotalDebitTrans").html("");

                    $("#spOpenbal").html("");
                    $("#spTotaldebit").html("");
                    $("#spTotalCredit").html("");
                    $("#spClosingbal").html("");
                    $("#spTotalDebitTrans").html("");
                } else {
                    $("#spOpenbal").html("");
                    $("#spTotaldebit").html("");
                    $("#spTotalCredit").html("");
                    $("#spClosingbal").html("");
                    $("#spTotalDebitTrans").html("");
                    alert(result.MESSAGE);
                }
            },
            error: function (jqXHR, textStatus) {
                //alert(jqXHR.responseText.trim());
            }
        });
    },
    ExportCardStatement: function () {
        var datas = {
            id: dnn.getVar("CardID"),
            dateRp: dnn.getVar("dateRp"),
            type: "Export"
        };

        window.open("/DesktopModules/IBRBController/API/Customer/GetCardStatement?" + $.param(datas));
        $("#fl-close-tranaction-export").click();
    },
    SendEmailCardStatement: function () {
        var datas = {
            id: dnn.getVar("CardID"),
            dateRp: dnn.getVar("dateRp"),
            type: "SendEmail",
            email: dnn.getVar("EmailUser")
        };
        $.ajax({
            type: "GET",
            cache: false,
            url: this.bs + "GetCardStatement",
            beforeSend: this.sf.setModuleHeaders,
            data: datas,
            success: function (result) {
                if (result.STATUSCODE == "000000") {
                    $('.mail_send').addClass('show');
                    $.fancybox.close();
                    setTimeout(function () {
                        $('.mail_send').removeClass('show');
                    }, 5000);
                }
            },
            error: function (jqXHR, textStatus) {
                //alert(jqXHR.responseText.trim());
            }
        });
    },
    PrintCardStatement: function () {
        var d = {
            id: dnn.getVar("CardID"),
            dateRp: dnn.getVar("dateRp"),
            type: "Print"
        };
        if (navigator.userAgent.toLowerCase().indexOf('firefox') > 0
            || navigator.userAgent.toLowerCase().indexOf('chrome') > 0) {
            var win = window.open("/DesktopModules/IBRBController/API/Customer/GetCardStatement?" + $.param(d), "width:800,height=800");
        }
        else {

            var myWindow = window.open("", "myWindow", "width=200,height=100");
            myWindow.document.write('<iframe id="frame1" height="800" width="800" src="/DesktopModules/IBRBController/API/Customer/GetCardStatement?' + $.param(d) + '"></iframe>', "width:800,height=800");
        }

    },
}

var accountAdressBook = {
    SF: null,
    BS: null,
    PageSize: "10",
    PageIndex: "1",
    TotalRecord: 0,
    Order: "ASC",
    IsReload: true,
    Init: function () {
        // behavior Check box
        $(".fl-address-book-btn-delete").click(function () {
            if ($(this).hasClass("fl-btn-active")) {
                if ((deleted_data != null && deleted_data.length > 1)
                    || $('#chk_check_all').is(':checked'))
                {
                    $('#msgConfirmDelete').text(vibcode.ConfirmBeforeDeleteAll);
                }
                if (Number(accountAdressBook.TotalRecord) > 0) {
                    $.fancybox({ href: "#fl_dialog_fl_delete_book" });
                }
            }
        });
        $("#fl-btn-book-delete").click(function () {
            $.fancybox.close();
            //tiếp tục thực hiện lệnh xóa
            accountAdressBook.handleDeleteAddress();
        });
        $("#fl-btn-book-delete-cancel").click(function () {
            $.fancybox.close();
        });
        $("#chk_check_all").click(function () {
            $(".fl-address-book-list-content input[type='checkbox']").prop("checked", $(this).is(":checked"));
            if ($(this).is(":checked")) {
                $("#fl-address-book-btn-delete").html(vibcode.SelectAll);
                $("#fl-address-book-btn-delete").addClass("fl-btn-active");
                
            } else {
                $("#fl-address-book-btn-delete").html(vibcode.SelectDeleted);
                $("#fl-address-book-btn-delete").removeClass("fl-btn-active");
            }
            accountAdressBook.handleCheckboxChanged();
        });
        $(".fl-address-book-order").click(function () {
            if ($(this).hasClass("fl-az")) {
                $(this).removeClass("fl-az");
                $(this).addClass("fl-za");
                accountAdressBook.handleOrderPages(false);
            } else {
                $(this).removeClass("fl-za");
                $(this).addClass("fl-az");
                accountAdressBook.handleOrderPages(true);
            }
        });
        $('#btnSearch').click(function () {
            accountAdressBook.handleSearch($('#txtSearch').val());
        });

        if (jQuery_1_11_1('#account') != null) {
            jQuery_1_11_1('#account').prettyDropdown();
            jQuery_1_11_1('#account').on('change', accountAdressBook.handleAccountChanged);
        }

        // get template file
        $.get(templatefile, null, function (templates) {
            if (!templatefileaddtemptobody) {
                templates = templates.replace("{Edit_Header}", vibcode.Edit_Header);
                $('body').append(templates);
                templatefileaddtemptobody = true;
                accountAdressBook.loadAddressHeader();
                accountAdressBook.bindAddressList(true);
            }
        });

        $(document).keypress(function (e) {
            if (e.keyCode == 13) {
                accountAdressBook.handleSearch($('#txtSearch').val());
                e.preventDefault();
            }
        });

    },
    getHeaderNames: function (lstHeaders) {
        if (lstHeaders != null
            && lstHeaders != "") {
            for (var i = 0; i <= lstHeaders.length - 1 ; i++) {
                vibcode[lstHeaders[i].Value] = lstHeaders[i].Text;

            }
        }
    },
    loadAddressHeader: function () {
        var curAccount = jQuery_1_11_1('#account').val();
        if (curAccount == null
            || curAccount == undefined
            || curAccount === "") {
            curAccount = "All";
        }
        var headerData = vibcode[curAccount + "_Header"];
        if (headerData != null
            && headerData != "") {
            var headers = headerData.split("|");
            $('.fl-address-book-list-header .fl-address-book-list-col-2').text(headers[0].trim());
            $('.fl-address-book-list-header .fl-address-book-list-col-3').text(headers[1].trim());
            $('.fl-address-book-list-header .fl-address-book-list-col-4').text(headers[2].trim());
        }
    },
    bindAddressList: function (isPaging) {
        var moduletype = jQuery_1_11_1('#account').val();
        var search = $('#txtSearch').val();
        var params = {
            search: dnn.encodeHTML(search),
            moduletype: dnn.encodeHTML(moduletype),
            pageindex: accountAdressBook.PageIndex,
            order: dnn.encodeHTML(accountAdressBook.Order),
            isreload: accountAdressBook.IsReload,
        };
        $.ajax({
            type: "GET",
            url: accountAdressBook.BS + "GetAccountAddessList",
            beforeSend: accountAdressBook.SF.setModuleHeaders,
            data: params,
            cache: false,
            success: function (result) {
                if (typeof result !== "undefined" && result != null && result.STATUSCODE == "000000") {
                    $("#pnlError").hide();
                    accountAdressBook.IsReload = false;
                    $(".fl-address-book-list-content ul li").remove();
                    $(".fl-address-book-list-content ul").append($('#rowTmpl').tmpl(result.DATA));
                    $("#book-pagging-total").text(result.TOTALRECORDS);
                    $('#result').text(vibcode.result);
                    if (Number(result.TOTALRECORDS) > 1
                        && $('#result').text().indexOf('result') == 0)
                    {
                        $('#result').text('results');
                    }
                    $(".fl-address-book-list-content ul").show();
                    if (isPaging) {
                        $('.fl-address-book-pagging-detail').empty();
                        accountAdressBook.InitPaging(result.TOTALRECORDS);
                    }
                    $(".fl-address-book-list-content input[type='checkbox']").change(accountAdressBook.handleCheckboxChanged);
                }
                else {
                    $(".fl-address-book-list-content ul li").remove();
                    $("#book-pagging-total").text("0");
                    $('.fl-address-book-pagging-detail').empty();
                    accountAdressBook.refeshUI();
                    accountAdressBook.ShowMessage(result.MESSAGE);
                }
            },
            error: function (xhr, textStatus) {
                accountAdressBook.ShowMessage(vibcode.Error);
                RBAjaxError(xhr, textStatus);
            }
        });
    },
    refeshUI: function () {
        // remove check data
        $("#fl-address-book-btn-delete").html(vibcode.SelectDeleted);
        $("#fl-address-book-btn-delete").removeClass("fl-btn-active");
        $("#chk_check_all").prop("checked", "");
    },
    ShowMessage: function (msg) {
        $("#lblErrorMessage").html(msg);
        $("#pnlError").show();

    },

    // check box behavior
    handleCheckboxChanged: function () {
        var i = 0;
        var n = 0;
        var data = [];
        $(".fl-address-book-list-content input[type='checkbox']").each(function (index) {
            if ($(this).is(":checked")) {
                i += 1;
                data.push($(this).attr('data'));
            }
            n += 1;
        });
        if (i > 0) {
            $("#fl-address-book-btn-delete").html(lbl_delete + " (" + i + ")");
            $("#fl-address-book-btn-delete").addClass("fl-btn-active");
            deleted_data = data;
        } else {
            $("#fl-address-book-btn-delete").html(lbl_delete);
            $("#fl-address-book-btn-delete").removeClass("fl-btn-active");
            deleted_data = [];
        }
    },
    handleDeleteAddress: function () {
        var benIds = deleted_data != null && deleted_data.length > 0 ? JSON.stringify(deleted_data) : {};
        if (deleted_data.length == 0) {
            accountAdressBook.ShowMessage(vibcode.RequiredSelection);
            return false;
        }
        var params = {
            BenId: benIds
        };
        $.ajax({
            type: "POST",
            url: accountAdressBook.BS + "DeleteAddress",
            beforeSend: accountAdressBook.SF.setModuleHeaders,
            data: params,
            cache: false,
            success: function (result) {
                if (result != null && result.STATUSCODE == "000000") {
                    $("#pnlError").hide();
                    alert(vibcode.DeleteSuccessfully);
                    accountAdressBook.refeshUI();
                    accountAdressBook.IsReload = true;
                    accountAdressBook.bindAddressList(false);
                }
                else {
                    accountAdressBook.ShowMessage(result.MESSAGE);
                }
            },
            error: function (xhr, textStatus) {
                accountAdressBook.ShowMessage(vibcode.Error);
                RBAjaxError(xhr, textStatus);
            }
        });
    },
    // Paging
    InitPaging: function (totalRecords) {

        var pageCount = Number(totalRecords) / Number(accountAdressBook.PageSize);
        var startPage = Number(accountAdressBook.PageIndex) - 1;
        var pageStart = (startPage * Number(accountAdressBook.PageSize)) + 1;
        var pageStop = Number(accountAdressBook.PageSize) + (startPage * Number(accountAdressBook.PageSize));
        var paging = $('.fl-address-book-pagging-detail');
        accountAdressBook.TotalRecord = Number(totalRecords);
        if (totalRecords < pageStop) {
            return true;
        }
        if (paging != null && pageCount > 0) {
            // Start page
            $('<a href="javascript:void(0)" class="fl-pagging-pre"></a>').click(accountAdressBook.HandlePrePage).appendTo(paging);
            for (var i = startPage ; i <= pageCount; i++) {
                $('<a href="javascript:void(0)" class="fl-pagging">' + pageStart + ' - ' + pageStop + '</a>').click(accountAdressBook.HandleCurrentPage).appendTo(paging);
                if (i > 0 && ((i + 1) % 3) == 0
                    && totalRecords > pageStop) {
                    $('<a href="javacript:void(0)" class="fl-pagging" value="' + i + '">' + '....' + '</a>').click(accountAdressBook.handleMovePaging).appendTo(paging);
                    break;
                }
                pageStart = pageStop + 1;
                pageStop += Number(accountAdressBook.PageSize);
            }
            $('.fl-pagging').first().addClass("active");
            $('<a href="javascript:void(0)" class="fl-pagging-next"></a>').click(accountAdressBook.HandleNextPage).appendTo(paging);
        }
    },
    HandlePrePage: function (e) {
        var pageIndex = 0;
        var length = $('.fl-pagging').length;
        var paging = $('.fl-pagging');
        if (length > 0) {
            var tmp = null;
            for (var i = 0; i < length; i++) {
                tmp = paging[i];
                if ($(tmp).hasClass('active')) {
                    pageIndex = i;
                    break;
                }
            }

            if (pageIndex == 0) {
                if (accountAdressBook.PageIndex > 1) {
                    accountAdressBook.PageIndex = Number(accountAdressBook.PageIndex) - 1;
                    accountAdressBook.handleMovePaging();
                    return;
                }
                return;
            }
            else {
                $(tmp).removeClass('active');
                $(tmp).prev().addClass('active');
            }
            accountAdressBook.PageIndex = Number(accountAdressBook.PageIndex) - 1;
            accountAdressBook.bindAddressList(false);
        }
    },
    HandleNextPage: function (e) {
        var pageIndex = 0;
        var length = $('.fl-pagging').length;
        var paging = $('.fl-pagging');
        var morePage = false;
        if (length > 0) {
            var tmp = null;
            for (var i = 0; i < length; i++) {
                tmp = paging[i];
                if ($(tmp).hasClass('active')) {
                    pageIndex = i;
                }
                if($(tmp)[0].innerHTML == "....")
                {
                    morePage = true;
                }
            }


            if (morePage && (pageIndex == length - 2)) {
                accountAdressBook.PageIndex = Number(accountAdressBook.PageIndex) + 3;
                accountAdressBook.handleMovePaging();
                return;
            }
            else if(!morePage && (pageIndex == length -1))
            {
                return;
            }
            else {
                accountAdressBook.PageIndex = Number(accountAdressBook.PageIndex) + 1;
                $($('.fl-pagging')[pageIndex]).removeClass('active');
                $($('.fl-pagging')[pageIndex]).next().addClass('active');
            }
            accountAdressBook.bindAddressList(false);
        }
    },
    HandleCurrentPage: function (e) {
        if (e.currentTarget.innerHTML != ""
             && e.currentTarget.innerHTML != undefined) {
            $('.fl-pagging').removeClass("active");
            $(this).addClass("active");
            var pageIndexes = e.currentTarget.innerHTML.split("-");
            var pageIndex = Number(pageIndexes[1].trim()) / 10;
            accountAdressBook.PageIndex = pageIndex;
            accountAdressBook.bindAddressList(false);
        }
    },
    handleMovePaging: function () {
        var totalRecords = accountAdressBook.TotalRecord;
        var startPage = $(this).attr('value') == null || $(this).attr('value') == undefined ?
                (Number(accountAdressBook.PageIndex) - 3) : Number($(this).attr('value')) + 1;
        var pageCount = Number(totalRecords) / Number(accountAdressBook.PageSize);
        var pageStart = (startPage) * Number(accountAdressBook.PageSize) + 1;
        var pageStop = (startPage + 1) * Number(accountAdressBook.PageSize);

        if (totalRecords < pageStop) {
            return true;
        }
        accountAdressBook.PageIndex = startPage + 1;

        var paging = $('.fl-address-book-pagging-detail');
        $('.fl-pagging').remove();
        $('.fl-pagging-pre').remove();
        $('.fl-pagging-next').remove();
        if (paging != null && pageCount > 0) {
            // Start page
            $('<a href="javacript:void(0)" class="fl-pagging-pre"></a>').click(accountAdressBook.HandlePrePage).appendTo(paging);
            for (var i = startPage  ; i <= pageCount; i++) {
                $('<a href="javacript:void(0)" class="fl-pagging" value="' + i + '">' + pageStart + ' - ' + pageStop + '</a>').click(accountAdressBook.HandleCurrentPage).appendTo(paging);
                if (i > 0 && ((i + 1) % 3) == 0
                    && totalRecords > pageStop) {
                    $('<a href="javacript:void(0)" class="fl-pagging" value="' + i + '">' + '....' + '</a>').click(accountAdressBook.handleMovePaging).appendTo(paging);
                    break;
                }
                pageStart = pageStop + 1;
                pageStop += Number(accountAdressBook.PageSize);
            }
            $('.fl-pagging').first().addClass("active");
            $('<a href="javacript:void(0)" class="fl-pagging-next"></a>').click(accountAdressBook.HandleNextPage).appendTo(paging);
        }
        accountAdressBook.bindAddressList(false);
    },
    handleOrderPages: function (isAsc) {
        if (isAsc)
            accountAdressBook.Order = "ASC";
        else
            accountAdressBook.Order = "DESC";
        accountAdressBook.refeshUI();
        accountAdressBook.bindAddressList(true);
    },
    handleSearch: function (search) {
        accountAdressBook.refeshUI();
        accountAdressBook.PageIndex = "1";
        accountAdressBook.bindAddressList(true);

    },
    handleAccountChanged: function () {
        accountAdressBook.refeshUI();
        accountAdressBook.loadAddressHeader();
        accountAdressBook.PageIndex = "1";
        accountAdressBook.bindAddressList(true);
        jQuery_1_11_1('#account').prettyDropdown().refresh();
    },

}

var editAddress = {
    SF: null,
    BS: null,
    BenId: null,
    ModuleId: null,
    init: function () {
        $("#ddlInternationalBankList,#ddlInterBank").selectmenu({
            style: 'popup',
            width: '337px',
            height:'50px',
            format: editAddress.ddlBankListFormatting
        });
        $("#pnlError,#divSuccess,#divDetail,#divEditForm").hide();
        $("#trCurrency,#trStatus,#trCurrency2,#trStatus2").hide();
        $("#spHBankName,#spHBranch,#spHCity,#spHAccountCity,#spHAccountAddress,#txtBankName,#imgBankNameCancel").hide();

        $('#btnSave').click(editAddress.save);
        $("#slLBABank").change(function () {
            editAddress.bindLCTBranch();
            $("#slExtBranch").change();
            if (this.value === "000") {
                $("#slLBABank").hide();
                $("#txtBankName,#imgBankNameCancel").show();
            }
        });
        $("#slLCTState").change(function () {
            editAddress.bindLCTBranch();
            $("#slExtBranch").change();
        });
        $("#imgLCTBranchCancel").click(function () {
            $("#slExtBranch").show();
            $("#slExtBranch")[0].selectedIndex = 0;
            $("#txtBranch,#imgLCTBranchCancel").hide();
        });
        $("#imgBankNameCancel").click(function () {
            $("#slLBABank").show();
            $("#txtBankName,#imgBankNameCancel").hide();
        });
        $("#slExtBranch").change(function () {
            if (this.value === vibcode.LCTBranchOther
                || this.value === "null") {
                $("#slExtBranch").hide();
                $("#txtBranch,#imgLCTBranchCancel").show();
            } else {
                $("#slExtBranch").show();
                $("#txtBranch,#imgLCTBranchCancel").hide();
            }
        });
        $('#txtAccountType').attr("disabled", "disabled");
        $('#txtStatus').attr("disabled", "disabled");

        if ($('#hfAccountType').val() == vibcode.LBA) {
            $("#slLBABank").change();
            $(".fl-book-edit-form").css("height", "440px");
        }

        if ($('#txtAccountAddress') != null &&
            $('#txtAccountAddress').attr('disabled') == "disabled") {
            $('#txtAccountAddress').removeClass('area-text1');
        }
        
        $("#ddlInternationalBankList").change(function () {
            $("#txtInternationalSwiftCode").val("");
            if (this.value != BIC_OTHER && this.value != "") {                
                $("#divInternationalBankLBL").removeClass("hidden");
                var name = $("#ddlInternationalBankList").find(":selected").text();
                $("#divInternationalBankLBL").find("span").html(name.replace(this.value,"<span style='font-weight: bold;'>"+this.value+"</span>"));
                $("#ddlInternationalBankList-button").css("display","block");
            } else {
                $("#divInternationalBankLBL").addClass("hidden");
                $("#divInternationalBankListOther").removeClass("hidden");
                $("#ddlInternationalBankList").addClass("hidden");
                $('#tblInternationalName').removeClass("hidden");
                $("#ddlInternationalBankList-button").css("display","none");              
            }
        });
        $("#ddlInterBank").change(function () {
            $("#txtInterSwiftCode").val("");
            if (this.value != BIC_OTHER && this.value != "") {
                $("#divInterBankLBL").removeClass("hidden");
                var name = $("#ddlInterBank").find(":selected").text();
                $("#divInterBankLBL").find("span").html(name.replace(this.value,"<span style='font-weight: bold;'>"+this.value+"</span>"));
                $("#ddlInterBank-button").css("display","block");
            } else {
                $("#divInterBankLBL").addClass("hidden");
                $("#divInterBankListOther").removeClass("hidden");
                $("#ddlInterBank").addClass("hidden");

                $('#tblInterName').removeClass("hidden");
                $("#ddlInterBank-button").css("display","none");
            }
        });

        $('#chkInterBank').change(function () {
            if ($(this).is(':checked')) {
                $('#Intermediary_bank_details').removeClass("hidden");
            } else {
                $('#Intermediary_bank_details').addClass("hidden");
            }
        });



        $('#lnkInternationalNameCancel').click(function () {
            $('#tblInternationalName').addClass("hidden");
            $('#divInternationalBankListOther').addClass("hidden");
            $('#txtInternationalNameBankName').val('');
            $("#ddlInternationalBankList-button").css("display","block");
            $("#ddlInternationalBankList").removeClass("hidden");
        });
        $('#lnkInterNameCancel').click(function () {
            $('#tblInterName').addClass("hidden");
            $('#divInterBankListOther').addClass("hidden");
            $('#divInterBankList').removeClass("hidden");
            $('#txtInterNameBankName').val('');
            $("#ddlInterBank-button").css("display","block");
            $("#ddlInterBank").removeClass("hidden");
        });
        
        $("#txtInternationalSwiftCode").change(function () {
            editAddress.txtSwiftCode_Change(this);
        });
        $("#txtInterSwiftCode").change(function () {
            editAddress.txtSwiftCode_Change(this);
        });
        $("#rdbInternationalName,#rdbInternationalSwift").click(function () {
            if (this.id == "rdbInternationalName") {
                $("#tblInternationalSwift").addClass("hidden");
            } else {
                $("#tblInternationalSwift").removeClass("hidden");
                $("#lnkInternationalNameCancel").click();
            }
        });
        $("#rdbInterName,#rdbInterSwift").click(function () {
            if (this.id == "rdbInterName") {
                $("#tblInterSwift").addClass("hidden");
            } else {
                $("#tblInterSwift").removeClass("hidden");
                $('#lnkInterNameCancel').click();
            }
        });

        //event show content edit
        if ($('#rdbInternationalName:checked').val() === "rdbInternationalName") {
            $("#ddlInternationalBankList").change();
            
        }else{
            $("#txtInternationalSwiftCode").change();
        }
        if ($('#rdbInterName:checked').val() === "rdbInterName") {
            $("#ddlInterBank").change();            
        }else{
            $("#txtInterSwiftCode").change();
        }
        $("#chkInterBank").change();


        $("#ddlCountry").selectmenu({
            style: 'popup',
            width: '337px',
            height: '50px',
        });
        $("#ddlCountry").change(function () {
            if (INTERNATIONAL_REQUIRED_BSB.indexOf(this.value) != -1) {
                $("#tblBSB").removeClass("hidden");
            } else {
                $("#tblBSB").addClass("hidden");
            }
            if (INTERNATIONAL_REQUIRED_IBAN.indexOf(this.value) != -1) {
                $("#tblIBAN").removeClass("hidden");
            } else {
                $("#tblIBAN").addClass("hidden");
            }
        });
        $('#ddlCountry').change();
        if ($("#txtVisa").val() != "") {
            $("#tblVisa").removeClass("hidden");
        }
        if ($("#txtPassport").val() != "") {
            $("#tblPassport").removeClass("hidden");
        }
        //end event show
    },
    bindLCTBranch: function () {
        $('#slExtBranch').empty();
        var pas = {
            bankcode: $('#slLBABank').val(),
            state: $('#slLCTState').val()
        };
        $.ajax({
            type: "GET",
            url: editAddress.BS + "GetExtBranch",
            beforeSend: editAddress.SF.setModuleHeaders,
            data: pas,
            contentType: "application/json; charset=utf-8",
            cache: false,
            async: false,
            success: function (result) {
                if (typeof result !== "undefined" && result != null && result.data != null
					&& result.data.length > 1) {
                    $.each(result.data, function (i, item) {
                        var tmp = '<option value=' + item.Code + '>' + item.Name + '</option>';
                        $(tmp).appendTo('#slExtBranch');
                    });
                }
            },
            error: function (xhr, textStatus) {
                RBAjaxError(xhr, textStatus);
            }
        });
    },
    save: function () 
    {
        var AccountType = $("#hfAccountType").val() == null ? '' : $("#hfAccountType").val();
        if(AccountType=="IBA"){            
            editAddress.SaveIBA();            
            return;
        }
        
        var AccountName = $.trim($("#txtAccountName").val());
        var AccountNickName = $.trim($("#txtAccountNickName").val());
        var accountAddress = $("#txtAccountAddress").val() == null ? '' : $.trim($("#txtAccountAddress").val());
        var accountNumber = $("#txtAccountNumber").val() == null ? '' : $.trim($("#txtAccountNumber").val());
        var branch = $("#txtBranch").val() != null ? $("#txtBranch").val().trim() : '';
        var branchCode = $("#slExtBranch").val() != null && $("#slExtBranch").val() != "null" ? $("#slExtBranch").val() : '';
        var City = $('#slLCTState').val() == null ? '' : $('#slLCTState').val();
        
        var BankId = $('#slLBABank').val() == null ? '' : $('#slLBABank').val();
        var bankName = $('#txtBankName').val() == null ? '' : $('#txtBankName').val();

        revCustName.controltovalidate = "txtAccountName";
        suc = Page_ClientValidate("validCustName");
        if (!suc) {
            var errorMessage = "";
            if (!revCustName.isvalid && $("#txtAccountName").attr("disabled") == undefined)
                errorMessage += revCustName.errormessage + " \n";
            if (!revCustAddress.isvalid && $("#txtAccountAddress").attr("disabled") == undefined)
                errorMessage += revCustAddress.errormessage + " \n";
            if (!revCustNumber.isvalid && $("#txtAccountNumber").attr("disabled") == undefined)
                errorMessage += revCustNumber.errormessage + " \n";
            if (!revBankName.isvalid && $("#slLBABank").val() == "000")
                errorMessage += revBankName.errormessage + " \n";
            if (!revBranch.isvalid && ($("#slExtBranch").val() == "" || $("#slExtBranch").val() == null))
                errorMessage += revBranch.errormessage + " \n";
            if (errorMessage != "") {
                editAddress.ShowMessage(errorMessage);
                return;
            }
        }

        if (AccountType == "LBA") {
            if (AccountName == '' || branch == '' || BankId == '' || City == '') {
                editAddress.ShowMessage(vibcode.InvalidData);
                return;
            }
        }

        var fId = editAddress.BenId;
        var name = editAddress.ModuleId;

        var params = {
            fId: dnn.encodeHTML(fId),
            Name: dnn.encodeHTML(name),
            AccountName: dnn.encodeHTML(AccountName),
            AccountNickName: dnn.encodeHTML(AccountNickName),
            BankId: dnn.encodeHTML(BankId),
            Branch: branch,
            City: dnn.encodeHTML(City),
            Branchcode: branchCode,
            Module: AccountType,
            AccountAddress: dnn.encodeHTML(accountAddress),
            AccountNumber: dnn.encodeHTML(accountNumber),
            BankName: dnn.encodeHTML(bankName),
        };
        $.ajax({
            type: "POST",
            url: editAddress.BS + "Save",
            data: params,
            beforeSend: editAddress.SF.setModuleHeaders
        }).done(function (rs) {
            if (rs.STATUSCODE === vibcode.SUCCESSED) {
                $("#pnlError").hide();
                alert(vibcode.UpdateSuccess);
            } else {
                $("#divSuccess").hide();
                editAddress.ShowMessage(rs.MESSAGE);
            }
        }).fail(function (xhr, result, status) {
            editAddress.ShowMessage(vibcode.Error);
            RBAjaxError(xhr, status);
        });
    },
    ShowMessage: function (msg) {
        $("#lblErrorMessage").html(msg);
        $("#pnlError").show();
        $('body,html').animate({
            scrollTop: $('#lblErrorMessage').offset().top - 100
        }, 800);
    },
    txtSwiftCode_Change: function (a) {        
        var code = a.value.trim();
        if(code==""){
            if (a.id == "txtInternationalSwiftCode") {
                $("#spInternationalSwiftName").html('');            
            }else{
                $("#spInterSwiftName").html("");  
            }
            return;
        }  
        var datap = {
            code: code
        };
        $.ajax({
            type: "GET",
            url: "/DesktopModules/RBTransferController/API/WebAPI/"+ "GetBic",
            data: datap,
            beforeSend: editAddress.SF.setModuleHeaders,
            contentType: "application/json; charset=utf-8",
            success: function (result) {
                if (result.STATUSCODE == "000000" && result.DATA != null && result.DATA.length > 0) {
                    if (a.id == "txtInternationalSwiftCode") {
                        $("#spInternationalSwiftName").html(result.DATA[0].BankNameAddress);
                        $("#rdbInternationalSwift").click();
                        $("#divInternationalBankLBL").addClass("hidden");
                    } else {
                        $("#spInterSwiftName").html(result.DATA[0].BankNameAddress);
                        $("#rdbInterSwift").click();
                        $("#divInterBankLBL").addClass("hidden");                        
                    }
                } else{
                    editAddress.ShowMessage(messageObj.IBA_Message_SwiftNotValid);
                    if (a.id == "txtInternationalSwiftCode") {
                        $("#spInternationalSwiftName").html("");                        
                    } else {
                        $("#spInterSwiftName").html("");  
                    }
                }
            },
            error: function (xhr, textStatus) {
                RBAjaxError(xhr, textStatus);
            }
        });
    },
    SaveIBA: function () {        
        // var lstInput = $('input[type="text"]');
        // if (lstInput.length > 0) {
        //     for (k = 0; k < lstInput.length; k++) {
        //         if(lstInput[k].value != ""){
        //             if(checkkytu(lstInput[k].value, kytudacbiet)) {
        //                 editAddress.ShowMessage("Không sử dụng ký tự đặc biệt");
        //                 if(lstInput[k].id!=null&&lstInput[k].id!=undefined)
        //                 $("#"+lstInput[k].id).focus();
        //                 return;
        //             }                          
        //         }                  
        //     }
        // }  
       
        if (!rdbInternationalSwift_IsChecked() && !rdbInternationalName_IsChecked()) {
            editAddress.ShowMessage(messageObj.IBA_Message_SelectBank);
            return false;
        }
        if (rdbInternationalSwift_IsChecked()) {
            if ($('#txtInternationalSwiftCode').val().trim().length == 0) {
                editAddress.ShowMessage(messageObj.IBA_Message_SelectBank);
                return false;
            }
        }
        if (rdbInternationalName_IsChecked()) {
            //bo sung them check cac thogn tin khac nua
            if ($("#ddlInternationalBankList").val() == BIC_OTHER) {
                if ($('#txtInternationalNameBankName').val().trim().length == 0) {
                    editAddress.ShowMessage(messageObj.IBA_Message_InputBankName);
                    return false;
                }
                if ($('#txtInternationalNameBranch').val().trim().length == 0) {
                    editAddress.ShowMessage(messageObj.IBA_Message_InputBranch);
                    return false;
                }
                if ($('#txtInternationalNameCity').val().trim().length == 0) {
                    editAddress.ShowMessage(messageObj.IBA_Message_InputBankCity);
                    return false;
                }
                //if ($('#txtInternationalNameCountry').val().trim().length == 0) {
                //    editAddress.ShowMessage(messageObj.IBA_Message_InputBankCountry);
                //    return false;
                //}
            }
        }

        if ($('#txtReceiveAcctName').val().trim().length == 0) {
            editAddress.ShowMessage(messageObj.IBA_Message_InputBenName);
            return false;
        }       

        if ($('#chkInterBank').is(':checked')) {
            if (!rdbInterSwift_IsChecked() && !rdbInterName_IsChecked()) {
                editAddress.ShowMessage(messageObj.IBA_Message_SelectBank);
                return false;
            }
            if (rdbInterSwift_IsChecked()) {
                if ($('#txtInterSwiftCode').val().trim().length == 0) {
                    editAddress.ShowMessage(messageObj.IBA_Message_SwiftNotValid);
                    return false;
                }
            }
            if (rdbInterName_IsChecked()) {
                if ($('#ddlInterBank').val().trim() == BIC_OTHER) {
                    if ($('#txtInterBankName').val().trim().length == 0) {
                        editAddress.ShowMessage(messageObj.IBA_Message_InputBankName);
                        return false;
                    }
                    if ($('#txtInterBranch').val().trim().length == 0) {
                        editAddress.ShowMessage(messageObj.IBA_Message_InputBranch);
                        return false;
                    }
                    if ($('#txtInterCity').val().trim().length == 0) {
                        editAddress.ShowMessage(messageObj.IBA_Message_InputBankCity);
                        return false;
                    }
                    if ($('#txtInterCountry').val().trim().length == 0) {
                        editAddress.ShowMessage(messageObj.IBA_Message_InputBankCountry);
                        return false;
                    }
                }
            }
           /* if (INTERNATIONAL_REQUIRED_BSB.indexOf($("#ddlCountry").val()) != -1) {
                var visaEx=$("#txtVisaExpiry").val();
                if(!isDate(visaEx)){
                    editAddress.ShowMessage(messageObj.IBA_Message_InputDateInvalid);
                    return false;
                }
            } 
            if (INTERNATIONAL_REQUIRED_IBAN.indexOf($("#ddlCountry").val()) != -1) {
                var ppEx=$("#txtPassportExpiry").val();
                if(!isDate(ppEx)){
                    editAddress.ShowMessage(messageObj.IBA_Message_InputDateInvalid);
                    return false;
                }
            }*/ 
             
        }
        var visaEx=$("#txtVisaExpiry").val();
        if(visaEx!=""&&!isDateVisa(visaEx)){
            return false;
        }
        var ppEx=$("#txtPassportExpiry").val();
        if(ppEx!=""&&!isDate(ppEx)){
            return false;
        }

        if (INTERNATIONAL_REQUIRED_BSB.indexOf($("#ddlCountry").val()) != -1) {
                
            if($("#txtBSB").val()==""){
                editAddress.ShowMessage(messageObj.IBA_Message_InputBSB);
                return false;
            }
        } 
        if (INTERNATIONAL_REQUIRED_IBAN.indexOf($("#ddlCountry").val()) != -1) {                
            if($("#txtIBAN").val()==""){
                editAddress.ShowMessage(messageObj.IBA_Message_InputIBAN);
                return false;
            }
        }
            
        $("#btnSaveIBA").click();
    },
    ddlBankListFormatting: function (text) {
        var newText = text;
        //array of find replaces
        var findreps = [
            { find: /^([^\-]+) (PARAM1) /g, rep: '<span class="ui-selectmenu-item-banklistparam1">$1</span>' },
            { find: /([^\|><]+) (PARAM2) /g, rep: '<span class="ui-selectmenu-item-banklistparam2">$1</span>' },
            { find: /([^\|><]+)$/g, rep: '<span class="ui-selectmenu-item-banklistparam3">$1</span>' },
        ];

        for (var i in findreps) {
            newText = newText.replace(findreps[i].find, findreps[i].rep);
        }
        return newText;
    },
   
}
var rbiba = {
    sf: null,
    bs: null,
    addtemptobody: false,
    Init: function(moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('IBRBController') + 'Customer/';
    },
    InitTransIBA: function () {
        rbiba.GetListTransIBA(false, "", "");

        $(".fl-home-all-history-tranaction-content").scroll(function () {
            if ($("#translist li").last().offset().top <= $(".fl-home-all-history-tranaction-footer").offset().top - 35) {
                rbiba.LoadMoreTranHistIBA();
            }
        });
        $("#aSearch").click(function () {
            var dtfrom = $("#txtDateFrom").val();
            var dtto = $("#txtDateTo").val();
            if (dtfrom == "" || dtto == "") {
                alert(IBA_Message_SelectDate);
                return;
            } else {
                dnn.setVar("CurrentSearch_TotalItem","0");
                rbiba.GetListTransIBA(true, dtfrom, dtto);
            }
        });
        $("#aPrint").click(function () {
            var id = "printtranlist" + $.now();
            var divhide = $('<div/>', {
                style: "display:none;"
            });
            divhide.append('<link rel="stylesheet" type="text/css" href="/banners/skins/VIB-RB2/css/transferformIBA2.css" />');
            var div = $('<div/>', {
                id: id,
            });
            div.appendTo(divhide);
            var divlogo = $('<img/>', {
                src: "/portals/_default/skins/vib-retails/images/VIBlogo.jpg"
            });
            divlogo.appendTo(div);
            $(".spec-tit").clone().appendTo(div);
            $("#translist").clone().appendTo(div);
            divhide.appendTo($("body"));
            $("#" + id).printThis({
                debug: false,
                importCSS: true,
                importStyle: true,
                printContainer: true,
                pageTitle: "",
                removeInline: false,
                header: null,
                formValues: true,

            });
        });        
    },
    InitTransIBADetail: function () {
        $('.fancy').fancybox();
        $("#aPrintDetail").click(function () {
            var title = $(".spec-tit p").html();
            rbiba.IBAOpenPrintPopup(title, "divPrint");
        });
        $("input.input_otp").keyup(function (event) {
            var currentIndex = $(this).attr("id").replace('txtOtp', '');
            if (nextIndex == 6) return;
            var nextIndex = parseInt(currentIndex) + 1;
            $("#txtOtp" + nextIndex).focus();
        });
        $("#aUpdate").click(function (e) {
            e.preventDefault(); 
            var bFound=false;
            var lstInputFile = $('input[type="file"]');
            if (lstInputFile.length > 0) {
                for (k = 0; k < lstInputFile.length; k++) {
                    if(lstInputFile[k].value != ""){
                        bFound=true;  
                        break;  
                    } 
                }
                if(!bFound&&!changeDateExpire&&$("#hdfFileDelete").val()==""){                    
                    alert(msgNotUpdate);
                    return false;
                }
            }        
            $('#btnContinute').attr("action","Update");            
        });
        $("#aCancel").click(function () {
            $('#btnContinute').attr("action","Cancel");
        });
        $("#aDelete").click(function () {
            $('#btnContinute').attr("action","Delete");
        });
        $('#lnkGetOtp').click(function () {
            var opts = $('input.input_otp');
            for (var i = 0; i <opts.length; i++) {
                opts[i].value="";
            }
            rbiba.GetOTP();
        });
        $('.fl-chung-tu-btn-xoa').click(function () {
            var fileID=$('#'+this.id).attr("file-id");
            //$('.divLinkFile'+fileID).addClass('hidden');            
            var hdfFileDelete=$('#hdfFileDelete').val();
            if(hdfFileDelete!=""){
                $('#hdfFileDelete').val(hdfFileDelete+";"+fileID);                
            }else{
                $('#hdfFileDelete').val(fileID);
            }
            $("#txtDateExpired" + fileID).val('');
        });
        $('#btnContinute').click(function (e) {
            e.preventDefault();
            var opts = $('input.input_otp');
            if (opts == null
                || opts == undefined
                || opts.length == 0) {
                alert(msgPleaseEnterOTP);
                return;
            }

            var otp = "";
            for (var i = 0; i <= opts.length - 1; i++) {
                otp += opts[i].value;
            }

            if (otp.length != 6) {
                alert("Hay nhap OTP");
                return;
            }    
            var action=$('#btnContinute').attr("action");
            if(action=="Cancel"){
                rbiba.CancelTransIBA(otp);
            }else if(action=="Delete"){
                rbiba.DeleteTransIBA(otp);
            }else if(action=="Update"){
                $("#hdfOTP").val(otp);
                var lstInputFile = $('input[type="file"]');
                if (lstInputFile.length > 0 ||changeDateExpire) {
                    rbiba.uploadfile(lstInputFile, 0);
                }
            }
        });
        $(".fl-chung-tu-btn-xoa").click(function(){
            $("#" + this.id).parent().parent().find(".fl-val-chung-tu-item-link a").html("");  
            $("#" + this.id).addClass("hidden");      
        });
        $(".docExpired").change(function() {
            changeDateExpire = true;
        });

    },   
    FileChange: function (a) {
        var fname=a.files[0].name;
        if(a.files[0].size/1024>maxSizeFile){
            index = $('input[type="file"]').length;
            alert("File vuợt quá dung lượng: "+a.files[0].size/1024);
            a.value="";
            return;
        }
        $("#" + a.id).parent().parent().parent().find(".fl-val-chung-tu-item-link span.file-chung-tu-note").html(fname);
        $("#" + a.id).parent().parent().parent().find(".fl-val-chung-tu-item-link a").html(""); 
        $("#" + a.id).parent().parent().parent().find(".fl-val-chung-tu-item-link").removeClass("hidden"); 
       
    },
    uploadfile: function (lstInputFile, index) {
        if (lstInputFile[index].value != "") {
            var fileUpload = lstInputFile[index];
            var files = fileUpload.files;
            var dateExpiry=$("#txtDateExpired"+lstInputFile[index].id).val();

            var data = new FormData();
            for (j = 0; j < files.length; j++) {
                data.append(files[j].name, files[j]);
                data.append("fileID", lstInputFile[index].id);
                data.append("dateExpiry",dateExpiry);
            }
            $.ajax({
                type: "POST",
                url: "/DesktopModules/RBTransferController/API/WebAPI/" + "UploadFile",
                beforeSend: this.sf.setModuleHeaders,
                data: data,
                contentType: false,
                processData: false,
                success: function (result) {
                    if (result.STATUSCODE == "000000") {
                        index++;
                        if (index < lstInputFile.length) {
                            rbiba.uploadfile(lstInputFile, index);
                        } else {
                            //het file
                            rbiba.UpdateTransIBA();
                        }
                    } else {
                        index = lstInputFile.length;
                        alert(result.MESSAGE);
                    }
                },
                error: function (err) {
                    alert(err.statusText);
                }
            });

        } else {
            if(changeDateExpire){
                var dateExpiry=$("#txtDateExpired"+lstInputFile[index].id).val();
                if(dateExpiry!=""){
                    var data = new FormData();                    
                    data.append("fileID", lstInputFile[index].id);
                    data.append("dateExpiry",dateExpiry);
                    
                    $.ajax({
                        type: "POST",
                        url: "/DesktopModules/RBTransferController/API/WebAPI/"+ "UpdateFile",
                        beforeSend: this.sf.setModuleHeaders,
                        data: data,
                        contentType: false,
                        processData: false,
                        success: function (result) {
                            if (result.STATUSCODE == "000000") {
                                index++;
                                if (index < lstInputFile.length) {
                                    rbiba.uploadfile(lstInputFile, index);
                                } else {
                                    //het file
                                    rbiba.UpdateTransIBA();
                                }
                            } else {
                                index = lstInputFile.length;
                                alert(result.STATUSCODE);
                            }
                        },
                        error: function (err) {
                            alert(err.statusText);
                        }
                    });    
                }else{
                    index++;
                    if (index < lstInputFile.length) {
                        rbiba.uploadfile(lstInputFile, index);
                    } else {
                         rbiba.UpdateTransIBA();
                    }  
                }               
            }else{
                index++;
                if (index < lstInputFile.length) {
                    rbiba.uploadfile(lstInputFile, index);
                } else {
                     rbiba.UpdateTransIBA();
                }            
            }
        }
    },
    GetOTP: function (s) {
        $.ajax({
            type: "GET",
            cache: false,
            url: "/DesktopModules/RBTransferController/API/WebAPI/" + "GetOTP",
            beforeSend: this.sf.setModuleHeaders,
            success: function (data) {
                alert(data);
                //$('#lnkGetOtp').hide();
                //$('#btnContinute').show();
                $('#lnkGetOtp').fadeOut("slow");
                setTimeout(function () {
                    $('#lnkGetOtp').fadeIn("slow");
                }, 180000);
                $("#txtOtp1").focus();
            },
            error: function (xhr, textStatus) {
                RBAjaxError(xhr, textStatus);
                tabTopup.showErrorMessage(vibcode.Error);
            }
        });
        return false;
    },
    UpdateTransIBA: function () {
        var datap = {
            otp: $("#hdfOTP").val(),
            tranid: tranid,
            arrDelete:$("#hdfFileDelete").val()
        };
        $.ajax({
            type: "POST",
            cache: false,
            url: this.bs + "UpdateFileIBA",
            beforeSend: this.sf.setModuleHeaders,
            data: datap,
            success: function (data) {
                if (data.STATUSCODE == "000000") {
                    $.fancybox.close();
                    alert(data.MESSAGE);
                    window.location.href=urlListTran;
                }else{
                    alert(data.MESSAGE);
                    $('#lnkGetOtp').fadeIn("slow");
                }
            },
            error: function (xhr, textStatus) {
                RBAjaxError(xhr, textStatus);
                tabTopup.showErrorMessage(vibcode.Error);
            }
        });
        return false;
    },
    CancelTransIBA: function (otp) {
        var datap = {
            otp: otp,
            tranid: tranid
        };
        $.ajax({
            type: "POST",
            cache: false,
            url: this.bs + "CancelTransIBA",
            beforeSend: this.sf.setModuleHeaders,
            data: datap,
            success: function (data) {
                if (data.STATUSCODE == "000000") {
                    $.fancybox.close();
                    alert(data.MESSAGE);
                    window.location.href=urlListTran;
                }else{
                    alert(data.MESSAGE);
                    $('#lnkGetOtp').fadeIn("slow");
                }
            },
            error: function (xhr, textStatus) {
                RBAjaxError(xhr, textStatus);
                tabTopup.showErrorMessage(vibcode.Error);
            }
        });
        return false;
    },
    DeleteTransIBA: function (otp) {
        var datap = {
            otp: otp,
            tranid: tranid
        };
        $.ajax({
            type: "POST",
            cache: false,
            url: this.bs + "DeleteTransIBA",
            beforeSend: this.sf.setModuleHeaders,
            data: datap,
            success: function (data) {
                if (data.STATUSCODE == "000000") {
                    $.fancybox.close();
                    alert(data.MESSAGE);
                    window.location.href=urlListTran;
                }else{
                    alert(data.MESSAGE);
                    $('#lnkGetOtp').fadeIn("slow");
                }
            },
            error: function (xhr, textStatus) {
                RBAjaxError(xhr, textStatus);
                tabTopup.showErrorMessage(vibcode.Error);
            }
        });
        return false;
    },
    IBAOpenPrintPopup: function (title, divPrintableId) {
        //Creating new page
        var pp = window.open('', '', 'letf=0,top=0,width=800,height=600,toolbar=0,scrollbars=1,status=0');
        //Adding HTML opening tag with <HEAD> … </HEAD> portion
        pp.document.writeln('<HTML><HEAD><title>' + title + '</title>');
        pp.document.writeln('<!--[if lt IE 8]><link rel="stylesheet" href="/portals/_default/skins/vib-retails/css/ie7.css" type="text/css" /><![endif]-->');
        pp.document.writeln('<LINK href="/portals/_default/skins/vib-retails/css/style.css?v=1"  type="text/css" rel="stylesheet">');
        pp.document.writeln('<LINK href="/banners/skins/VIB-RB2/css/transferformIBA2.css"  type="text/css" rel="stylesheet">');
        pp.document.writeln('<LINK href="/banners/skins/VIB-RB2/css/look_feel.css"  type="text/css" rel="stylesheet" media="print"><base target="_self">');
        //pp.document.writeln('<style type="text/css" id="styleprint">');
        //
        //Ending Tag of </form>, </body> and </HTML>
        //pp.document.writeln('</style>');
        pp.document.writeln('</HEAD>');
        //Adding Body Tag
        //pp.document.writeln('<body MS_POSITIONING="GridLayout" bottomMargin="0" leftMargin="0" topMargin="0" rightMargin="0">');
        pp.document.writeln('<body>');
        //Adding form Tag
        pp.document.writeln('<form  method="post">');
        pp.document.writeln('<div style="text-align:left;">');
        //pp.document.writeln(dtnow);
        pp.document.writeln('</div>');
        pp.document.writeln('<div class="table5">');
        pp.document.writeln('<img src="/portals/_default/skins/vib-retails/images/VIBlogo.jpg">');
        pp.document.writeln('</div>');
        //Creating two buttons Print and Close within a table
        //pp.document.writeln('<div style="text-align:right"><INPUT ID="PRINT" type="button" value="Print" onclick="javascript:window.print();"><INPUT ID="CLOSE" type="button" value="Close" onclick="window.close();"></div>');
        //Writing print area of the calling page
        pp.document.writeln('<div class="fl-transfer-detail-content">');
        pp.document.writeln(document.getElementById(divPrintableId).innerHTML);
        pp.document.writeln('</div>');
        //Ending Tag of </form>, </body> and </HTML>
        pp.document.writeln("</form><script type='text/javascript'>window.addEventListener('load', (event) => {window.print()});</script>");
        pp.document.writeln('</body></HTML>');
        pp.document.close();
        //pp.document.close();
    },
    LoadMoreTranHistIBA: function () {
        var totaltran = parseInt(dnn.getVar("CurrentSearch_TotalItem"));
        if (totaltran <= $("#translist li").length) {
            return;
        }

        var dtfrom = dnn.getVar("CurrentSearch_dtfrom");
        var dtto = dnn.getVar("CurrentSearch_dtto");
        var pageindex = parseInt(dnn.getVar("CurrentSearch_pageindex"));
        var total = parseInt(dnn.getVar("CurrentSearch_TotalItem")); 
        if((pageindex*10)<total){ 
            rbiba.GetListTransIBA(false, dtfrom, dtto, pageindex + 1);
        }
    },
    GetListTransIBA: function (isrefresh, dtfrom, dtto, pageindex) {
        if (dnn.getVar("GetTransListRunning") === "Y" || dnn.getVar("GetTransListDone") === "Y") {
            return;
        }
        dnn.setVar("GetTransListRunning", "Y");

        if (!pageindex) {
            pageindex = "1";
        }

        dnn.setVar("CurrentSearch_dtfrom", dtfrom + "");
        dnn.setVar("CurrentSearch_dtto", dtto + "");
        dnn.setVar("CurrentSearch_pageindex", pageindex + "");
        if (isrefresh) {
            $("#translist").html("");
        }
        //string loginName, string transType, string transid, string status, long pageNum, string pageSize, out string message
        var dp = {
            dtfrom: dtfrom,
            dtto: dtto,
            pi: pageindex
        }
        $.ajax({
            type: "GET",
            url: this.bs + "GetListTransIBA",
            data: dp,
            cache: false,
            beforeSend: this.sf.setModuleHeaders,
        }).done(function (data) {
            if (data.STATUSCODE === "000000") {
                $.get(templateTransIBA, null, function (templates) {
                    var pi = dnn.getVar("CurrentSearch_pageindex");
                    if (pi === "1") {
                        dnn.setVar("CurrentSearch_TotalItem", data.TotalRecord + "");
                        if (data.TotalRecord == 0) {
                            rbiba.ShowEmptyTranHistIBA();
                            dnn.setVar("GetTransListRunning", "N");
                            return;
                        } else {
                            $("#divtranhistfooter").show();
                            $("#divTransactionNoItemContent").hide();
                        }
                    }

                    if (!templatefileaddtemptobody) {
                        $('body').append(templates);
                        templatefileaddtemptobody = true;
                    }
                    $("#templisttransinternational").tmpl(data.data).appendTo($("#translist"));
                });
            }else{
                alert(data.MESSAGE);
            }
            dnn.setVar("GetTransListRunning", "N");
            
        });
    },
    ShowEmptyTranHistIBA: function () {
        $("#translist").html("");
        $("#divtranhistfooter").hide();
        $("#divTransactionNoItemContent").show();
    },
}
function GetDateJson(jsonDate) {
    if (jsonDate === null) {
        return "";
    }
    var value = new Date(parseInt(jsonDate.substr(6)));
    return value.format("dd/MM/yyyy");
}
function formatCurrency(num) {
    num = num.toString().replace(/\$|\,/g,'');
    if(isNaN(num))
    num = "0";
    sign = (num == (num = Math.abs(num)));
    num = Math.floor(num*100+0.50000000001);
    num = Math.floor(num/100).toString();
    for (var i = 0; i < Math.floor((num.length-(1+i))/3); i++)
    num = num.substring(0,num.length-(4*i+3))+','+
    num.substring(num.length-(4*i+3));
    return (((sign)?'':'-') + num);
}
function checkkytu(val, invalidChar) {
    for (i = 0; i < val.length; i++) {
        if (invalidChar.indexOf(val[i]) >= 0) return true;
    }
    return false;
}
function checkregex(val, pattern) {    
    if (pattern.test(val)) {    
        return true;
    }
    return false;
}
function rdbInternationalSwift_IsChecked() {
    return $('#rdbInternationalSwift:checked').val() == "rdbInternationalSwift";
}

function rdbInternationalName_IsChecked() {
    return $('#rdbInternationalName:checked').val() == "rdbInternationalName";
}

function rdbInterSwift_IsChecked() {
    return $('#rdbInterSwift:checked').val() == "rdbInterSwift";
}

function rdbInterName_IsChecked() {
    return $('#rdbInterName:checked').val() == "rdbInterName";
}
function isDate(testDate){
    var date_regex = /^(0[1-9]|1\d|2\d|3[01])\/(0[1-9]|1[0-2])\/(19|20)\d{2}$/ ;
    if(!(date_regex.test(testDate)))
    {
        editAddress.ShowMessage(messageObj.IBA_Message_InputDateInvalid);
        return false;
    }
    var dateArr = testDate.split("/");
    var date = new Date(dateArr[2], dateArr[1] - 1, dateArr[0]);
    //var now = new Date();
    if (date.getFullYear() != dateArr[2] || (date.getMonth() + 1) != dateArr[1] || date.getDate() != dateArr[0]) {
        editAddress.ShowMessage(messageObj.IBA_Message_InputDateInvalid);
        return false;
    }
    //"23/10/2015"; // Oct 23
    var dateParts = testDate.split("/");
    var dateObject = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
    //dtngaymaiEx
    if(dateObject.getTime() < dtEx.getTime()){
        editAddress.ShowMessage(messageObj.IBA_Message_DatePassportInvalid);
        return false;
    }
    return true;
}
function isDateVisa(testDate) {
    var date_regex = /^(0[1-9]|1\d|2\d|3[01])\/(0[1-9]|1[0-2])\/(19|20)\d{2}$/;
    if (!(date_regex.test(testDate))) {
        editAddress.ShowMessage(messageObj.IBA_Message_DateInvalidFormat);
        return false;
    }
    var dateArr = testDate.split("/");
    var date = new Date(dateArr[2], dateArr[1] - 1, dateArr[0]);
    //var now = new Date();
    if (date.getFullYear() != dateArr[2] || (date.getMonth() + 1) != dateArr[1] || date.getDate() != dateArr[0]) {
        editAddress.ShowMessage(messageObj.IBA_Message_InputDateInvalid);
        return false;
    }
    //"23/10/2015"; // Oct 23
    var dateParts = testDate.split("/");
    var dateObject = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
    //dtngaymaiEx
    if (dateObject.getTime() < dtVisaEx.getTime()) {
        editAddress.ShowMessage(messageObj.IBA_Message_InputDateVisaInvalid);
        return false;
    }
    return true;
}

(function ($) {
    $.showprogress = function (progTit, progText) {
        $.hideprogress();
        $("BODY").append('<div id="processing_overlay"></div>');
        $("BODY").append(
		  '<div id="processing_container">' +
		    '<div id="processing_content">' +
		      '<div id="processing_message"><br/><br/><img src="/images/loading.gif" /></div>' +
			'</div>' +
		  '</div>');

        //var pos = ($.browser.msie && parseInt($.browser.version) <= 6) ? 'absolute' : 'fixed';
        var pos = (dnn.dom.browser.isType(dnn.dom.browser.InternetExplorer) && dnn.dom.browser.version <= 6) ? 'absolute' : 'fixed';
        $("#processing_container").css({
            position: pos,
            zIndex: 99999,
            padding: 0,
            margin: 0
        });

        $("#processing_container").css({
            minWidth: $("#processing_container").outerWidth(),
            maxWidth: $("#processing_container").outerWidth()
        });

        var top = (($(window).height() / 2) - ($("#processing_container").outerHeight() / 2)) + (-75);
        var left = (($(window).width() / 2) - ($("#processing_container").outerWidth() / 2)) + 0;
        if (top < 0) top = 0;
        if (left < 0) left = 0;

        // IE6 fix
        //if ($.browser.msie && parseInt($.browser.version) <= 6) top = top + $(window).scrollTop();
        if (dnn.dom.browser.isType(dnn.dom.browser.InternetExplorer) && dnn.dom.browser.version <= 6) top = top + $(window).scrollTop();
        $("#processing_container").css({
            top: top + 'px',
            left: left + 'px'
        });
        $("#processing_overlay").height($(document).height());
    },
    $.hideprogress = function () {
        $("#processing_container").remove();
        $("#processing_overlay").remove();
    },
    $.showmsg = function (msgEle, msgText, msgClass, msgIcon, msgHideIcon, autoHide) {
        var tblMsg;

        tblMsg = '<table width="100%" cellpadding="1" cellspacing="0" border="0" class="' + msgClass + '"><tr><td style="width:30px;" align="center" valign="middle">' + msgIcon + '</td><td>' + msgText + '</td><td style="width:30px;" align="center" valign="middle"><a href="javascript:void(0);" onclick="$(\'#' + msgEle + '\').toggle(400);">' + msgHideIcon + '</a></td></tr></table>';

        $("#" + msgEle).html(tblMsg);
        $("#" + msgEle).show();
        if (autoHide) {
            setTimeout(function () {
                $('#' + msgEle).fadeOut('normal')
            }, 10000
	        );
        }
    }
})(jQuery);
var rbForgotPassword = {
    sf: null,
    bs: null,
    forgotStep: 1,
    Init: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('AuthenticationServices') + 'Authentication/';
        $(document).ajaxStart(function () { $.showprogress('Get information', 'Loading.....', '<img src="/Images/loadingfinal.gif"/>') }).ajaxStop(function () { $.hideprogress() });
        $(".otp-box").keyup(function (e) {
            var charCode = (e.which) ? e.which : e.keyCode;
            //if ((charCode >= 48 && charCode <= 57) || (charCode >= 96 && charCode <= 105) || charCode == 229) {
                if ($(this).val().length > 0) {
                    $(this).val($(this).val().substr($(this).val().length - 1));
                }
                var currentIndex = $(this).attr("id").replace('txtotp', '');
                if (nextIndex == 6) return;
                var nextIndex = parseInt(currentIndex) + 1;
                $(this).parent().find("#txtotp" + nextIndex).focus();
                //if (charCode != 229) {
                //    if (charCode >= 96 && charCode <= 105) {
                //        charCode -= 48;
                //    }
                //    $(this).val(String.fromCharCode(charCode));
                //}
            //}
        });
        $(".popup-btn-close").click(function () {
            $.fancybox.close();
        });
        $(".otp-box").click(function () {
            $(this).select();
        });
        $(".fl-forgot-pass-control-pin").click(function () {
            $(this).select();
        });

        $(".fl-forgot-pass-control-pin").keyup(function (e) {
            var charCode = (e.which) ? e.which : e.keyCode;
            if ((charCode >= 48 && charCode <= 57) || (charCode >= 96 && charCode <= 105) || charCode == 229) {
                if ($(this).val().length > 0) {
                    $(this).val($(this).val().substr($(this).val().length - 1));
                }
                var currentIndex = $(this).attr("id").replace('txtpin', '');
                if (nextIndex == 6) return;
                var nextIndex = parseInt(currentIndex) + 1;
                $(this).parent().find("#txtpin" + nextIndex).focus();
                if (charCode != 229) {
                    if (charCode >= 96 && charCode <= 105) {
                        charCode -= 48;
                    }
                    $(this).val(String.fromCharCode(charCode));
                }
            }
        });
        $("#btnSubmit").click(function () {
            if (rbForgotPassword.forgotStep == 1) {
                rbForgotPassword.btnSubmit_Step1_Click();
            } else {
                rbForgotPassword.btnSubmit_Step2_Click();
            }
        });
        $("#btnGetOTP").click(function () {
            $.ajax({
                type: "GET",
                cache: false,
                url: rbForgotPassword.bs + "ForgotPwGetOTP",
                success: function (data) {
                    alert(data.MESSAGE);
                    $("#txtotp1").focus();
                    $('#btnGetOTP').fadeOut("slow");
                    var distime = 180000;
                    if (typeof (vibconstance) !== "undefined") {
                        distime = vibconstance.DisableTime;
                    }
                    setTimeout(function () {
                        $('#btnGetOTP').fadeIn("slow");
                    }, distime);

                },
                error: function () {
                }
            });
        });
        $("#btnChangePw").click(function () {
            var otp = "";
            var otp_inputed = true;
            $(".otp-box").each(function (index) {
                if ($(this).val() != "") {
                    otp += $(this).val();
                } else {
                    otp_inputed = false;
                    return;
                }
            });
            if (otp_inputed) {
                $.ajax({
                    type: "POST",
                    cache: false,
                    url: rbForgotPassword.bs + "ForgotPwSubmit",
                    data: { otp: otp },
                    beforeSend: rbForgotPassword.sf.setModuleHeaders,
                    success: function (data) {
                        if (data.STATUSCODE == "000000") {
                            $.fancybox.close();
                            $("#divChangePW").hide();
                            //$("#divChangePWSuccess").show();
                            $("#fl-forgot-pass-success").show();
                            $("#footer").addClass("ab-bottom");
                            $("#header .line_gray").hide();
                            //var wap_id = $("#wrapper").offset();
                            if ($(window).width() < 769) {
                                $(".fl-change-pass-header").css("height", $("#wrapper").outerHeight() - 128).css("position", "relative");
                            }
                            $("#header").addClass("headermobile");
                        }
                        else {
                            //alert("Mã OTP bạn nhập không đúng, vui lòng kiểm tra lại");
                            alert(vibMessage.OTP_Not_Correct);
                        }
                    },
                    error: function () {
                    }
                })
            } else {
                //alert("Bạn cần nhập mã OTP để xác nhận");
                alert(vibMessage.OTP_Message_Require);
            }
        });
        $('input[name=global_type]').change(function () {
            var value = $('input[name=global_type]:checked').val();
            if (value == "NIC") {
                $('#lblGlobalTypeText').text(vibMessage.Globale_Type_NIC_Text);
                $('#txtGlobalID').attr("placeholder", vibMessage.NIC_Placeholder);
            }
            else if (value == "IIC") {
                $('#lblGlobalTypeText').text(vibMessage.Globale_Type_IIC_Text);
                $('#txtGlobalID').attr("placeholder", vibMessage.IIC_Placeholder);
            }
            else {
                $('#lblGlobalTypeText').text(vibMessage.Globale_Type_PPT_Text);
                $('#txtGlobalID').attr("placeholder", vibMessage.PPT_Placeholder);
            }
        });
    },
    btnSubmit_Step1_Click: function () {
        var msg = "";
        if ($("#txtGlobalID").val().trim() == "") {
            $("#txtGlobalID").parent().removeClass("fl-check-success");
            $("#txtGlobalID").parent().addClass("fl-check-fail");
            //msg = "Bạn vui lòng nhập đầy đủ các thông tin";
            msg = vibMessage.Input_Message_Require;
        } else {
            $("#global").parent().removeClass("fl-check-fail");
        }
        if ($("#txtUsername").val().trim() == "") {
            $("#txtUsername").parent().removeClass("fl-check-success");
            $("#txtUsername").parent().addClass("fl-check-fail");
            //msg = "Bạn vui lòng nhập đầy đủ các thông tin";
            msg = vibMessage.Input_Message_Require;
        } else {
            $("#txtUsername").parent().removeClass("fl-check-fail");
        }
        if (msg !== "") {
            rbForgotPassword.ShowMessageErrorStep1(msg);
            return;
        }

        $.ajax({
            type: "POST",
            url: this.bs + "ForgotPwValidUser",
            data: { username: $("#txtUsername").val().trim(), globalid: $("#txtGlobalID").val().trim(), globaltype: $('input[name=global_type]:checked').val() },
            cache: false,
            beforeSend: this.sf.setModuleHeaders,
        }).done(function (data) {
            if (data.STATUSCODE !== "000000") {
                $("#txtGlobalID").parent().removeClass("fl-check-success");
                $("#txtGlobalID").parent().addClass("fl-check-fail");
                $("#txtUsername").parent().removeClass("fl-check-success");
                $("#txtUsername").parent().addClass("fl-check-fail");
                rbForgotPassword.forgotStep = 1;
                rbForgotPassword.ShowMessageErrorStep1(data.MESSAGE);
            } else {
                $("#txtGlobalID").parent().removeClass("fl-check-fail");
                $("#txtGlobalID").parent().addClass("fl-check-success");
                $("#txtUsername").parent().addClass("fl-check-success");
                $("#txtUsername").parent().removeClass("fl-check-fail");
                rbForgotPassword.forgotStep = 2;
                rbForgotPassword.ShowMessageErrorStep1("");
            }
        });

    },
    ShowMessageErrorStep1: function (msg) {
        if (msg != "") {
            $("#fl_forgot_step_1 .fl-control-err").html(msg);
            $(".fl-forgot-pass-form-containt .fl-forgot-pass-guidline-line").addClass("hidden");
            $("#fl_forgot_step_2").addClass("hidden");
            $(".fl-global-type").prop("disabled", false);
            $("#footer").removeClass("rl-bottom");
            $("#footer").addClass("ab-bottom");
        } else {
            $("#fl_forgot_step_1 .fl-control-err").html("");
            $(".fl-forgot-pass-form-containt .fl-forgot-pass-guidline-line").removeClass("hidden");
            $("#fl_forgot_step_2").removeClass("hidden");
            $("#txtGlobalID").parent().removeClass("fl-check-fail");
            $("#txtUsername").parent().removeClass("fl-check-fail");
            $("#txtGlobalID").parent().addClass("fl-check-success");
            $("#txtUsername").parent().addClass("fl-check-success");
            $("#txtGlobalID").prop("disabled", true);
            $("#txtUsername").prop("disabled", true);
            $(".fl-global-type").prop("disabled", true);
            $("#footer").removeClass("ab-bottom");
            $("#footer").addClass("rl-bottom");
        }
    },
    btnSubmit_Step2_Click: function () {
        var pincode = $("#txtpin1").val().trim() + $("#txtpin2").val().trim() + $("#txtpin3").val().trim() + $("#txtpin4").val().trim();
        var cardno = $("#txtcardnumber").val().trim();
        var msg = "";

        if (cardno == "") {
            $("#txtcardnumber").parent().removeClass("fl-check-success");
            $("#txtcardnumber").parent().addClass("fl-check-fail");
            msg = vibMessage.Input_Message_Require;
        } else {
            $("#txtcardnumber").parent().removeClass("fl-check-fail");
        }
        if (pincode.length != 4) {
            $(".fl-forgot-pass-pin-title").parent().removeClass("fl-check-success");
            $(".fl-forgot-pass-pin-title").parent().addClass("fl-check-fail");
            msg = vibMessage.Input_Message_Require;
        } else {
            $(".fl-forgot-pass-pin-title").parent().removeClass("fl-check-fail");
        }

        if (msg !== "") {
            rbForgotPassword.ShowMessageErrorStep2(msg);
            return;
        }

        var encrypt = new JSEncrypt();
        encrypt.setPublicKey(vibglobal_keyencryptcard);
        var cardNoEncryp = encrypt.encrypt(cardno);
        var pin = encrypt.encrypt(pincode);
        $.ajax({
            type: "POST",
            url: this.bs + "ForgotPwValidCard",
            data: { cardno: cardno, pin: pin, cardnoencrypted: cardNoEncryp },
            cache: false,
            beforeSend: this.sf.setModuleHeaders,
        }).done(function (data) {
            if (data.STATUSCODE !== "000000") {
                alert(data.MESSAGE);
            } else {
                $.fancybox.close();
                $.fancybox({ href: "#fl_dialog_opt" });
                if (data.ISSMSTOKEN) {
                    $("#divGetOTP").show();
                    $("#divSoftOTP").hide();
                }
                else {
                    $("#divGetOTP").hide();
                    $("#divSoftOTP").show();
                }
            }
        });
    },
    ShowMessageErrorStep2: function (msg) {
        if (msg != "") {
            //$("#fl_forgot_step_2 .fl-control-err").html(msg);
            $("#txtcardnumber").prop("disabled", false);
            $(".fl-forgot-pass-pin-title").prop("disabled", false);
            $("#footer").removeClass("rl-bottom");
            $("#footer").addClass("ab-bottom");
        } else {
            //$("#fl_forgot_step_2 .fl-control-err").html("");
            $("#txtcardnumber").parent().removeClass("fl-check-fail");
            $("#txtcardnumber").parent().addClass("fl-check-success");
            $(".fl-forgot-pass-pin-title").parent().removeClass("fl-check-fail");
            $(".fl-forgot-pass-pin-title").parent().addClass("fl-check-success");
            $("#txtcardnumber").prop("disabled", true);
            $(".fl-forgot-pass-pin-title").prop("disabled", true);
            $("#footer").removeClass("ab-bottom");
            $("#footer").addClass("rl-bottom");
        }
    },
}

var rbAccountBalance = {
    sf: null,
    bs: null,
    arrAcctID:"",
    vibconstance: null,
    addtemptobody: false,
    Init: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('IBRBController') + 'Customer/';
        //this.vibconstance = constance;
        $('input[name="check_all"]').bind('click', function () {
            var status=$(this).is(':checked');
            $('input[name="check_print"]').attr('checked', status);
            rbAccountBalance.check_Changed();  
        });
        $('#aPrint').bind('click', function () {
            if(rbAccountBalance.arrAcctID==""){
                alert(rbactportmyhome.AlertPleaseSelect);                
            }else{
                rbAccountBalance.Print();    
            }            
        });    
    },
    ShowListAccount: function () {
        $.ajax({
            type: "GET",
            url: this.bs + "MyAcctListHome",
            beforeSend: this.sf.setModuleHeaders,
            cache: false,
            success: function (rs) {
                if (typeof rs !== "undefined" && rs != null) {
                    if (rs.STATUSCODE === "000000") {
                        $.get("/DesktopModules/VIBEBank/jstemplate-balance.html?v=1", null, function (templates) {
                            if (!templatefileaddtemptobody) {
                                $('body').append(templates);
                                templatefileaddtemptobody = true;
                            }
                            $("#temprbhomeacctport").tmpl(rs.data).appendTo($("#myacctlist"));
                            $('input[name="check_print"]').bind('click', function () {
                                rbAccountBalance.check_Changed();                                
                            });
                        });
                    }
                }
            }
        });
    },
    ShowListAccountBalance: function () {
        $.ajax({
            type: "GET",
            url: this.bs + "MyAcctListBalance",
            beforeSend: this.sf.setModuleHeaders,
            cache: false,
            success: function (rs) {
                if (typeof rs !== "undefined" && rs != null) {
                    if (rs.STATUSCODE === "000000") {
                        $.get("/DesktopModules/VIBEBank/jstemplate-balance.html?v=1", null, function (templates) {
                            if (!templatefileaddtemptobody) {
                                $('body').append(templates);
                                templatefileaddtemptobody = true;
                            }
                            $("#temprbhomeacctport").tmpl(rs.data).appendTo($("#myacctlist"));
                            $('input[name="check_print"]').bind('click', function () {
                                rbAccountBalance.check_Changed();
                            });
                        });
                    }
                }
            }
        });
    },
    check_Changed: function () {
        var count=0;
        rbAccountBalance.arrAcctID="";
        $('input[name=check_print]').each(function () {
            if(this.checked){
                count++;
                rbAccountBalance.arrAcctID=rbAccountBalance.arrAcctID+$(this).attr("acctid")+";";
            } 
        });
        $("#lblCount").html(rbactportmyhome.TextSelect.replace("{{COUNT}}", count));
        if ($('input[name="check_print"]:checked').length == $('input[name="check_print"]').length) {
            $('input[name="check_all"]').attr('checked', true);
        }
        else {
            $('input[name="check_all"]').attr('checked', false);
        }
    },
    Print: function () {
        var ccy = $("#hdfCCY").val();
        window.open(this.bs + 'PrintAccountBalance?AcctID=' + rbAccountBalance.arrAcctID + '&ccy=' + ccy, '_blank');
    },
    SetCCY: function (val) {
        var ccy = $("#hdfCCY").val();
        if (ccy != val) {
            $("#hdfCCY").val(val);
        }
        else {
            $("#hdfCCY").val("");
            $('input[name="type_money"]').prop('checked', false);
        }
    }
}

var changeusername = {
    sf: null,
    bs: null,
    addtemptobody: false,
    isError: false,
    init: function (moduleid) {
        this.sf = $.ServicesFramework(moduleid);
        this.bs = this.sf.getServiceRoot('IBRBController') + 'Customer/';
        $.fancybox.open({
            href: "#change-popup",
            closeBtn: false, // hide close button
            closeClick: false, // prevents closing when clicking INSIDE fancybox
            helpers: {
                // prevents closing when clicking OUTSIDE fancybox
                overlay: { closeClick: false }
            },
            keys: {
                // prevents closing when press ESC button
                close: null
            }
        });
        $('#txtNewUsername').attr("placeholder", vibcode.placeHolder);
        $('#aYes,#aClose').click(function () {
            $.fancybox.close();
        });
        $(".account-suggestion").click(function () {
            $("#txtNewUsername").val($(this).html());
            $("#txtNewUsername").parent().removeClass("div-error").addClass("div-success");
            $(".lbl-error-div").hide();
            $("#lblError").html("");
            $("#divTip").hide();
            $("#confirmText").html(vibcode.confirmMess.replace("#", $(this).html()).replace("{0}", $("#txtCurrentUsername").val()));
            changeusername.checkIsValid();
        });
        $('#aNo').click(function () {
            $.ajax({
                type: "POST",
                url: changeusername.bs + "UpdateUsernameSetting",
                beforeSend: changeusername.sf.setModuleHeaders,
                data: "",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    location.reload();
                    $.showprogress('', 'Processing.....');
                },
                error: function () {
                    // alert('<%= LocalizeString("AJAXError") %>');
                }
            });
        });
        $('#btnChange').click(function () {
            if ($('#btnChange').hasClass("disabled")) {
                return;
            }
            $.fancybox.open({
                href: "#confirm-popup",
                closeBtn: false, // hide close button
                closeClick: false, // prevents closing when clicking INSIDE fancybox
                helpers: {
                    // prevents closing when clicking OUTSIDE fancybox
                    overlay: { closeClick: false }
                },
                keys: {
                    // prevents closing when press ESC button
                    close: null
                }
            });
        });

        $('#areciveotp').click(function () {
            if ($("#txtNewUsername").parent().hasClass("div-error")) {
                alert(vibcode.regNameMess);
                return;
            }
            else if ($(".otp-click").hasClass("nobackground")) {
                return;
            }
            else if ($("#txtNewUsername").parent().hasClass("div-success")) {
                changeusername.getOtp();
                //$(".otp-click").css("visibility", "hidden");
                $(".otp-click").addClass("nobackground");
                $('#areciveotp').addClass("disabled");
                var distime = 180000;
                setTimeout(function () {
                    //$(".otp-click").css("visibility", "visible")
                    $(".otp-click").removeClass("nobackground");
                    $('#areciveotp').removeClass("disabled");
                }, distime);
            }
            else {
                alert(vibcode.regNameMess);
                return;
            }
        });
        $('#aChange').click(function () {
            var newusername = $("#txtNewUsername").val().trim();
            var otp = $("#txtOtp1").val().trim() + $("#txtOtp2").val().trim() + $("#txtOtp3").val().trim() + $("#txtOtp4").val().trim() + $("#txtOtp5").val().trim() + $("#txtOtp6").val().trim();
            var params = {
                newusername: newusername,
                otp: otp
            };
            $.ajax({
                type: "POST",
                url: changeusername.bs + "UpdateUsername",
                beforeSend: changeusername.sf.setModuleHeaders,
                data: params,
                success: function (data) {
                    var isValid = true;
                    if (data.STATUSCODE == "000000") {
                        $("#resultText").html(vibcode.successMess);
                        $.fancybox.open({
                            href: "#result-popup",
                            closeBtn: false, // hide close button
                            closeClick: false, // prevents closing when clicking INSIDE fancybox
                            helpers: {
                                // prevents closing when clicking OUTSIDE fancybox
                                overlay: { closeClick: false }
                            },
                            keys: {
                                // prevents closing when press ESC button
                                close: null
                            }
                        });
                    }
                    else if (data.ISNEEDLOGOUT === "Y") {
                        $("#resultText").html(data.MESSAGE);
                        $.fancybox.open({
                            href: "#result-popup",
                            closeBtn: false, // hide close button
                            closeClick: false, // prevents closing when clicking INSIDE fancybox
                            helpers: {
                                // prevents closing when clicking OUTSIDE fancybox
                                overlay: { closeClick: false }
                            },
                            keys: {
                                // prevents closing when press ESC button
                                close: null
                            }
                        });
                    }
                    else {
                        alert(data.MESSAGE);
                        $.fancybox.close();
                    }
                },
                error: function () {
                    alert('<%= LocalizeString("AJAXError") %>');
                }
            });
        });
        $("input.nhap-otp").ForceNumericOnly();
        $("input.nhap-otp").focus(function () { $(this).select(); });
        $("input.nhap-otp").numeric(false, function () { this.value = ""; this.focus(); });
        $("input.nhap-otp").keyup(function (event) {
            var currentIndex = $(this).attr("id").replace('txtOtp', '');
            if (nextIndex == 6) return;
            var nextIndex = parseInt(currentIndex) + 1;
            $("#txtOtp" + nextIndex).focus();
            changeusername.checkIsValid();
        });
    },
    getOtp: function () {
        $.ajax({
            type: "POST",
            beforeSend: changeusername.sf.setModuleHeaders,
            url: changeusername.bs + "GetOTPAnonymous",
            data: "",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.d != '') {
                    alert(data.d);
                } else {
                    //alert('ma OTP da duoc gui cho quy khach');
                }
                $("#txtOtp1").focus();
            },
            error: function () {
                alert('<%= LocalizeString("AJAXError") %>');
            }
        });
    },
    checkIsValid: function () {
        var otp = $("#txtOtp1").val().trim() + $("#txtOtp2").val().trim() + $("#txtOtp3").val().trim() + $("#txtOtp4").val().trim() + $("#txtOtp5").val().trim() + $("#txtOtp6").val().trim();
        var username = $("#txtNewUsername").val().trim();
        var isValid = true;
        if ($("#txtNewUsername").parent().hasClass("div-error") || username === '') {
            isValid = false;
        }
        if (otp.length < 6) {
            isValid = false;
        }
        if (!isValid) {
            $("#btnChange").addClass("disabled");
        }
        else {
            $("#btnChange").removeClass("disabled");
        }
    },
    ValidUsernameInTemp: function () {
        if ($("#txtNewUsername").val().match(vibcode.regName)) {
            return true;
        } else {
            return false;
        }
    },
    checkUsername: function (newusername) {
        if (!changeusername.ValidUsernameInTemp()) {
            $("#btnChange").addClass("disabled");
            $("#lblError").html(vibcode.regNameMess);
            $("#txtNewUsername").parent().addClass("div-error").removeClass("div-success");
            $(".lbl-error-div").show();
            return;
        }
        //return;
        var params = {
            newusername: newusername,
        };
        $.ajax({
            type: "POST",
            url: changeusername.bs + "CheckNewUsername",
            beforeSend: changeusername.sf.setModuleHeaders,
            data: params,
            success: function (data) {
                var isValid = true;
                if (data.STATUSCODE == "000000") {
                    $("#txtNewUsername").parent().removeClass("div-error").addClass("div-success");
                    $(".lbl-error-div").hide();
                    $("#lblError").html("");
                    $("#divTip").hide();
                    $("#confirmText").html(data.CONFIRM.replace("#", newusername));
                }
                else {
                    isValid = false;
                    $("#lblError").html(data.MESSAGE);
                    $("#username-tip1").html(data.TIP1);
                    $("#username-tip2").html(data.TIP2);
                    $("#username-tip3").html(data.TIP3);
                    $("#username-tip4").html(data.TIP4);
                    $("#confirmText").html(data.CONFIRM);
                    $("#txtNewUsername").parent().addClass("div-error").removeClass("div-success");
                    $(".lbl-error-div").show();
                    if (data.STATUSCODE != '400074' && data.STATUSCODE != '400060') {
                        $("#divTip").show();
                    }
                }
                changeusername.checkIsValid();
            },
            error: function () {
                alert('<%= LocalizeString("AJAXError") %>');
                $("#lblError").html("loi");
                return false;
            }
        });
    },
    checkValidUsername: function (username) {
        changeusername.checkUsername(username);
    }
};
function showModal(modalId) {
    document.getElementById(modalId).classList.add('in');
    document.getElementById('modal-backdrop').classList.add('in');
}
function hideModal(modalId) {
    document.getElementById(modalId).classList.remove('in');
    document.getElementById('modal-backdrop').classList.remove('in');
    $("#modal-backdrop").hide();
}
function RBAjaxError() {
}


